<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Venta y M√°rgenes 2024 - 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .pdf-mode { width: 1200px !important; min-height: 100vh !important; overflow: visible !important; position: absolute !important; top: 0 !important; left: 0 !important; z-index: 9999 !important; background: #f8fafc !important; padding: 40px !important; }
        .pdf-mode .grid { display: grid !important; }
        .hide-on-pdf { display: none !important; }
        .page-break { page-break-before: always; margin-top: 40px; border-top: 2px dashed #cbd5e1; padding-top: 40px; }
        
        /* Strategic View Styles */
        .strat-view { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 12px; }
        .strat-view .container-like { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 40px; }
        .strat-view .alert-banner { background: white; border: 3px solid #dc2626; color: #1f2937; padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .strat-view .alert-banner h2 { font-size: 1.8em; margin-bottom: 12px; font-weight: bold; color: #dc2626; }
        .strat-view .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .strat-view .metric-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border-left: 5px solid; position: relative; transition: transform 0.3s ease; }
        .strat-view .metric-card:hover { transform: translateY(-5px); }
        .strat-view .metric-card.purple { border-left-color: #7b2cbf; } .strat-view .metric-card.purple .metric-value { color: #7b2cbf; }
        .strat-view .metric-card.red { border-left-color: #dc2626; } .strat-view .metric-card.red .metric-value { color: #dc2626; }
        .strat-view .metric-card.green { border-left-color: #059669; } .strat-view .metric-card.green .metric-value { color: #059669; }
        .strat-view .metric-card.orange { border-left-color: #ea580c; } .strat-view .metric-card.orange .metric-value { color: #ea580c; }
        .strat-view .metric-label { font-size: 0.75em; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 12px; }
        .strat-view .metric-value { font-size: 2.5em; font-weight: bold; margin-bottom: 8px; line-height: 1; }
        .strat-view .metric-change { font-size: 0.9em; font-weight: 600; display: flex; align-items: center; gap: 5px; color: #dc2626; }
        .strat-view .chart-container { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .strat-view .chart-title { font-size: 1.5em; color: #333; margin-bottom: 20px; font-weight: 600; }
        .strat-view .chart-wrapper { position: relative; height: 400px; }
        .strat-view .table-container { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow-x: auto; }
        .strat-view table { width: 100%; border-collapse: collapse; }
        .strat-view th { background: linear-gradient(135deg, #7b2cbf 0%, #5a189a 100%); color: white; padding: 15px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.85em; }
        .strat-view td { padding: 15px; border-bottom: 1px solid #e5e7eb; }
        .strat-view .highlight-row { background-color: #fef3c7; font-weight: 600; }
        .strat-view .number { font-family: 'Courier New', monospace; font-weight: 600; }
        .strat-view .negative-value { color: #dc2626; }
        .strat-view .positive-value { color: #059669; }
        .strat-view .insight-box { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 5px solid #f59e0b; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .strat-view .priority-section { background: white; border-radius: 15px; padding: 30px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); border-left: 6px solid; }
        .strat-view .priority-section.priority-1 { border-left-color: #dc2626; background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%); }
        .strat-view .priority-section.priority-2 { border-left-color: #ea580c; background: linear-gradient(135deg, #ffffff 0%, #ffedd5 100%); }
        .strat-view .priority-section.priority-3 { border-left-color: #7b2cbf; background: linear-gradient(135deg, #ffffff 0%, #f3e8ff 100%); }
        .strat-view .priority-section.control { border-left-color: #059669; background: linear-gradient(135deg, #ffffff 0%, #d1fae5 100%); }
        .strat-view .priority-header { margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .strat-view .priority-badge { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.75em; font-weight: bold; }
        .strat-view .priority-2 .priority-badge { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .strat-view .priority-3 .priority-badge { background: linear-gradient(135deg, #7b2cbf 0%, #5a189a 100%); }
        .strat-view .control-badge { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .strat-view .action-item { display: flex; gap: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .strat-view .action-number { min-width: 40px; height: 40px; background: linear-gradient(135deg, #7b2cbf 0%, #5a189a 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; flex-shrink: 0; }
        .strat-view .timeline-section { background: white; border-radius: 15px; padding: 40px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .strat-view .final-warning { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 3px solid #dc2626; border-radius: 15px; padding: 30px; margin-top: 30px; text-align: center; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        // 1. GLOBALS & ICONS
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LineChart, Line, BarChart, Bar, AreaChart, Area, XAxis, YAxis, 
            CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell 
        } = window.Recharts || {};

        const Icon = ({ name, className }) => {
            const icons = {
                dollar: <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
                scale: <g><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" strokeLinejoin="round"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></g>,
                trendingUp: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
                chart: <g><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></g>,
                pie: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                fileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></g>,
                dashboard: <g><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></g>,
                loader: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                globe: <g><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></g>,
                users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                filter: <g><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></g>,
                alert: <g><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></g>,
                clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
                calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                chevronDown: <polyline points="6 9 12 15 18 9"/>,
                chevronUp: <polyline points="18 15 12 9 6 15"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || icons.dollar}
                </svg>
            );
        };

        // 2. CONSTANTS
        const API_URL = "https://script.google.com/macros/s/AKfycbyNBTYR5Wzcb3NH6l9dwjSd_PP6L7EX0wZC1AyPZfGrn7fV8S4OnrAcQwlSwrVSK97w/exec";
        const COLORS = { year2024: "#4169E1", year2025: "#9333EA", positive: "#10b981", negative: "#ef4444", grid: "#e2e8f0" };
        const MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const EXCHANGE_RATES = { MXN: 1, USD: 0.05, EUR: 0.045 };

        const TRANSLATIONS = {
            es: {
                subtitle: "An√°lisis de venta y m√°rgenes 2024 - 2025",
                footer: "SSC GOURMET DISTRIBUTION",
                tabDesc: { dashboard: "Resumen ejecutivo de KPIs", growth: "An√°lisis de crecimiento", margin: "Rentabilidad y costos", customers: "Rentabilidad por cliente", analysis: "Visi√≥n estrat√©gica" },
                tabs: { dashboard: "Dashboard General", growth: "Crecimiento General", margin: "Margen & Rentabilidad", customers: "An√°lisis por Cliente", analysis: "An√°lisis de Margen (Estrat√©gico)" },
                kpis: { totalRevenue: "Facturaci√≥n Total", totalKg: "KG Totales Entregados", avgMargin: "Margen Promedio por KG", totalProfit: "Beneficio Total", growthRevenue: "Crecimiento Facturaci√≥n", growthVol: "Crecimiento Volumen (KG)", marginPct: "% de Margen Global", marginGap: "Diferencia vs 2024", profitability: "Rentabilidad" },
                charts: { monthlyRevenue: "Facturaci√≥n Mensual Comparativa", topClients: "Top 5 Clientes", topRecipes: "Top 5 Recetas (Volumen KG)", monthlyComp: "Comparativa Mensual", quarterly: "Crecimiento Trimestral", priceVsCost: "Evoluci√≥n Precio vs Costo", profitComp: "Composici√≥n Beneficio vs Costo" },
                table: { client: "Raz√≥n Social", sale: "Venta", growth: "Crecimiento", q: "Trimestre", change: "Cambio", concept: "Concepto", price: "Precio Prom/KG", cost: "Costo Prom/KG", margin: "Margen/KG", marginPct: "% Margen", recipe: "Receta", profit: "Beneficio Total", branch: "Sucursal", avgVol: "Vol. Prom (Kg/Ticket)", totalVol: "Vol. Total (Kg)", opportunity: "Oportunidad", marginAbs: "Margen $", contribution: "Aportaci√≥n", others: "Otros (Vol < 20kg)", eval: "Evaluaci√≥n", variety: "Variedad / Mezcla", margin24: "Margen 2024", margin25: "Margen 2025" },
                obs: { general: "Observaciones Generales", growth: "An√°lisis de Crecimiento", margin: "An√°lisis de Rentabilidad", customers: "Insights de Clientes" },
                common: { downloadPdf: "Descargar Vista Actual", downloadFull: "Descargar Informe Completo", loading: "Cargando datos...", error: "Error cargando datos", year: "A√±o", price: "Precio", cost: "Costo", margin: "Margen", profit: "Beneficio", vs: "vs", generating: "Generando PDF...", allMonths: "Todos los Meses", groupBy: "Agrupar por", fiscalId: "Raz√≥n Social", location: "Sucursal", period: "Periodo", source: "Fuente", currency: "Divisa", exchangeRate: "Tipo de Cambio" },
                strat: { mainTitle: "üìä Dashboard: An√°lisis de Margen", mainSub: "Comparativa 2024 vs 2025", alertTitle: "SITUACI√ìN GENERAL", alertDesc: "Ca√≠da dram√°tica del margen", alertSub: "Margen actual 45.60% - Por debajo del umbral saludable", kpi1: "MARGEN PROMEDIO KG 2025", kpi1Sub: "‚Üì $34.08 vs 2024", kpi2: "% MARGEN GLOBAL 2025", kpi2Sub: "‚Üì -16.0 pts", kpi3: "BENEFICIO TOTAL 2025", kpi3Sub: "‚Üì -7.6% vs 2024", kpi4: "MARGEN PERDIDO ANUAL", kpi4Sub: "$366K por mes", chart1Title: "Evoluci√≥n Precio vs Costo", clickToHide: "Da click en la leyenda para ocultar", lostMarginTitle: "¬øDe d√≥nde sale el Margen Perdido?", lostMarginExp: "¬øC√≥mo se calcula?", lostMarginDesc: "Si hubieras mantenido el mismo % de margen que en 2024, ¬øcu√°nto dinero extra tendr√≠as?", lostMarginStep1: "PASO 1: Margen esperado", lostMarginStep1Desc: "Ventas 2025 √ó Margen 2024", lostMarginStep2: "PASO 2: Margen real", lostMarginStep2Desc: "Margen REAL 2025", lostMarginStep3: "PASO 3: Diferencia", lostMarginStep3Desc: "Esperado - Real", lostMarginViz1: "Esperado (61.6%)", lostMarginViz2: "Real (45.6%)", lostMarginVizGap: "Diferencia", lostMarginDaily1: "Por mes", lostMarginDaily2: "Por trimestre", lostMarginFinal: "Est√°s absorbiendo costos en lugar de transferirlos.", chart2Title: "Margen por Tipo", table3Title: "Top 5 Variedades por Beneficio", table2Title: "Top 5 Clientes por Margen", planTitle: "Plan de Acci√≥n", timelineTitle: "Timeline", p1: "PRIORIDAD 1", p1Title: "Ajuste Precios", p2: "PRIORIDAD 2", p2Title: "Negociaci√≥n", p3: "PRIORIDAD 3", p3Title: "Optimizaci√≥n Mix", ctrl: "CONTROL", ctrlTitle: "Monitoreo", warnTitle: "Consecuencias", warnDesc: "Riesgo de inviabilidad si no se act√∫a.", marketProjTitle: "Proyecciones Mercado 2026", marketProjSub: "Tendencias Internacionales", marketContext: "Volatilidad esperada.", marketSources: [{name: "Banco Mundial", items: ["Baja estimada en ar√°bica"]}, {name: "WalletInvestor", items: ["Tendencia alcista"]}, {name: "Rabobank", items: ["Estabilizaci√≥n"]}], marketConclTitle: "Conclusi√≥n", marketConclDesc: "Ajustes preventivos recomendados.", steps: [{t:"Aumento base",d:"Recuperar margen perdido"},{t:"Estrategia escalonada",l:["Inmediato: Nuevos","30 d√≠as: Flexibles"]},{t:"Contratos",d:"Fijar a 6-12 meses"}], time: {w1:"Sem 1-2", prep:"Prep", l1:["An√°lisis costos"], w3:"Sem 3-4", exec:"Ejec", l2:["Comunicaci√≥n"], m2:"Mes 2", imp:"Imp", l3:["Aumentos"], m3:"Mes 3", eval:"Eval", l4:["Ajuste"]}}
            },
            fr: {
                subtitle: "Analyse des ventes et marges 2024 - 2025", footer: "SSC GOURMET DISTRIBUTION", tabDesc: { dashboard: "R√©sum√© ex√©cutif", growth: "Analyse de croissance", margin: "Rentabilit√© et co√ªts", customers: "Rentabilit√© par client", analysis: "Vision strat√©gique" },
                tabs: { dashboard: "Tableau de Bord", growth: "Croissance G√©n√©rale", margin: "Marge & Rentabilit√©", customers: "Analyse Client", analysis: "Analyse de la Marge (Strat√©gique)" },
                kpis: { totalRevenue: "Chiffre d'Affaires Total", totalKg: "KG Totaux Livr√©s", avgMargin: "Marge Moyenne par KG", totalProfit: "B√©n√©fice Total", growthRevenue: "Croissance CA", growthVol: "Croissance Volume (KG)", marginPct: "% Marge Globale", marginGap: "√âcart vs 2024", profitability: "Rentabilit√©" },
                charts: { monthlyRevenue: "Revenus Mensuels Comparatifs", topClients: "Top 5 Clients", topRecipes: "Top 5 Recettes", monthlyComp: "Comparaison Mensuelle", quarterly: "Croissance Trimestrielle", priceVsCost: "√âvolution Prix vs Co√ªt", profitComp: "Composition B√©n√©fice vs Co√ªt" },
                table: { client: "Raison Sociale", sale: "Vente", growth: "Croissance", q: "Trimestre", change: "Chang.", concept: "Concept", price: "Prix Moy/KG", cost: "Co√ªt Moy/KG", margin: "Marge/KG", marginPct: "% Marge", recipe: "Recette", profit: "B√©n√©fice Total", branch: "Succursale", avgVol: "Vol. Moy", totalVol: "Vol. Total", opportunity: "Opportunit√©", marginAbs: "Marge $", contribution: "Contribution", others: "Autres", eval: "√âvaluation", variety: "Vari√©t√©", margin24: "Marge 2024", margin25: "Marge 2025" },
                obs: { general: "Observations G√©n√©rales", growth: "Analyse Croissance", margin: "Analyse Rentabilit√©", customers: "Aper√ßu Client" },
                common: { downloadPdf: "T√©l√©charger Vue", downloadFull: "T√©l√©charger Rapport Complet", loading: "Chargement...", error: "Erreur", year: "Ann√©e", price: "Prix", cost: "Co√ªt", margin: "Marge", profit: "B√©n√©fice", vs: "vs", generating: "G√©n√©ration...", allMonths: "Tous les mois", groupBy: "Grouper par", fiscalId: "Raison Sociale", location: "Succursale", period: "P√©riode", source: "Source", currency: "Devise", exchangeRate: "Taux" },
                strat: { mainTitle: "üìä Tableau de Bord Marge", mainSub: "Comparatif 2024 vs 2025", alertTitle: "SITUATION G√âN√âRALE", alertDesc: "Chute dramatique marge", alertSub: "Marge actuelle 45.60% - Critique", kpi1: "MARGE MOYENNE KG 2025", kpi1Sub: "‚Üì 34.08$ vs 2024", kpi2: "% MARGE GLOBALE", kpi2Sub: "‚Üì -16.0 pts", kpi3: "B√âN√âFICE TOTAL", kpi3Sub: "‚Üì -7.6%", kpi4: "MARGE PERDUE", kpi4Sub: "366K$ par mois", chart1Title: "√âvolution Prix vs Co√ªt", clickToHide: "Cliquez pour masquer", lostMarginTitle: "D'o√π vient la Marge Perdue ?", lostMarginExp: "Calcul ?", lostMarginDesc: "Si vous aviez gard√© la marge 2024, combien auriez-vous ?", lostMarginStep1: "√âTAPE 1 : Marge attendue", lostMarginStep1Desc: "Ventes 2025 x Marge 2024", lostMarginStep2: "√âTAPE 2 : Marge r√©elle", lostMarginStep2Desc: "Marge R√âELLE 2025", lostMarginStep3: "√âTAPE 3 : Diff√©rence", lostMarginStep3Desc: "Attendue - R√©elle", lostMarginViz1: "Attendue (61.6%)", lostMarginViz2: "R√©elle (45.6%)", lostMarginVizGap: "Diff√©rence", lostMarginDaily1: "Par mois", lostMarginDaily2: "Par trimestre", lostMarginFinal: "Vous absorbez des co√ªts au lieu de les transf√©rer.", chart2Title: "Marge par Type", table3Title: "Top 5 Vari√©t√©s", table2Title: "Top 5 Clients Marge", planTitle: "Plan d'Action", timelineTitle: "Calendrier", p1: "PRIORIT√â 1", p1Title: "Ajustement Prix", p2: "PRIORIT√â 2", p2Title: "N√©gociation", p3: "PRIORIT√â 3", p3Title: "Optimisation Mix", ctrl: "CONTR√îLE", ctrlTitle: "Suivi", warnTitle: "Cons√©quences", warnDesc: "Risque d'invabilit√©.", marketProjTitle: "Projections March√© 2026", marketProjSub: "Tendances", marketContext: "Volatilit√© attendue.", marketSources: [{name: "Banque Mondiale", items: ["Baisse estim√©e ar√°bica"]}, {name: "WalletInvestor", items: ["Hausse soutenue"]}, {name: "Rabobank", items: ["Stabilisation"]}], marketConclTitle: "Conclusion", marketConclDesc: "Ajustements pr√©ventifs recommand√©s.", steps: [{t:"Augmentation base",d:"R√©cup√©rer marge"},{t:"Strat√©gie √©chelonn√©e",l:["Imm√©diat","30 jours"]}], time: {w1:"Sem 1-2", prep:"Pr√©p", l1:["Analyse co√ªts"], w3:"Sem 3-4", exec:"Ex√©c", l2:["Comm"], m2:"Mois 2", imp:"Mise en ≈ìuvre", l3:["Hausse"], m3:"Mois 3", eval:"√âval", l4:["Ajuster"]}}
            },
            en: {
                subtitle: "Sales and Margin Analysis 2024 - 2025", footer: "SSC GOURMET DISTRIBUTION", tabDesc: { dashboard: "KPI Executive Summary", growth: "Growth Analysis", margin: "Profitability Breakdown", customers: "Customer Profitability", analysis: "Strategic Vision" },
                tabs: { dashboard: "General Dashboard", growth: "General Growth", margin: "Margin & Profitability", customers: "Customer Analysis", analysis: "Margin Analysis (Strategic)" },
                kpis: { totalRevenue: "Total Revenue", totalKg: "Total KG Delivered", avgMargin: "Avg Margin per KG", totalProfit: "Total Profit", growthRevenue: "Revenue Growth", growthVol: "Volume Growth (KG)", marginPct: "% Global Margin", marginGap: "Difference vs 2024", profitability: "Profitability" },
                charts: { monthlyRevenue: "Monthly Revenue Comparison", topClients: "Top 5 Clients", topRecipes: "Top 5 Recipes", monthlyComp: "Monthly Comparison", quarterly: "Quarterly Growth", priceVsCost: "Price vs Cost Evolution", profitComp: "Profit vs Cost Composition" },
                table: { client: "Legal Entity", sale: "Sale", growth: "Growth", q: "Quarter", change: "Change", concept: "Concept", price: "Avg Price/KG", cost: "Avg Cost/KG", margin: "Margin/KG", marginPct: "% Margin", recipe: "Recipe", profit: "Total Profit", branch: "Branch", avgVol: "Avg Vol", totalVol: "Total Vol", opportunity: "Opportunity", marginAbs: "Margin $", contribution: "Contribution", others: "Others", eval: "Evaluation", variety: "Variety", margin24: "Margin 2024", margin25: "Margin 2025" },
                obs: { general: "General Observations", growth: "Growth Analysis", margin: "Profitability Analysis", customers: "Customer Insights" },
                common: { downloadPdf: "Download View", downloadFull: "Download Full Report", loading: "Loading...", error: "Error", year: "Year", price: "Price", cost: "Cost", margin: "Margin", profit: "Profit", vs: "vs", generating: "Generating...", allMonths: "All Months", groupBy: "Group by", fiscalId: "Legal Entity", location: "Branch", period: "Period", source: "Source", currency: "Currency", exchangeRate: "Rate" },
                strat: { mainTitle: "üìä Dashboard: Margin Analysis", mainSub: "Comparison 2024 vs 2025", alertTitle: "GENERAL SITUATION", alertDesc: "Dramatic margin drop", alertSub: "Current margin 45.60% - Critical", kpi1: "AVG MARGIN KG 2025", kpi1Sub: "‚Üì $34.08 vs 2024", kpi2: "% GLOBAL MARGIN", kpi2Sub: "‚Üì -16.0 pts", kpi3: "TOTAL PROFIT 2025", kpi3Sub: "‚Üì -7.6%", kpi4: "ANNUAL LOST MARGIN", kpi4Sub: "$366K per month", chart1Title: "Price vs Cost Evolution", clickToHide: "Click to hide", lostMarginTitle: "Where does Lost Margin come from?", lostMarginExp: "How is it calculated?", lostMarginDesc: "If you kept 2024 margin, how much extra money would you have?", lostMarginStep1: "STEP 1: Expected Margin", lostMarginStep1Desc: "Sales 2025 x Margin 2024", lostMarginStep2: "STEP 2: Real Margin", lostMarginStep2Desc: "REAL Margin 2025", lostMarginStep3: "STEP 3: Difference", lostMarginStep3Desc: "Expected - Real", lostMarginViz1: "Expected (61.6%)", lostMarginViz2: "Real (45.6%)", lostMarginVizGap: "Difference", lostMarginDaily1: "Per month", lostMarginDaily2: "Per quarter", lostMarginFinal: "You are absorbing costs instead of passing them on.", chart2Title: "Margin by Type", table3Title: "Top 5 Varieties", table2Title: "Top 5 Clients Margin", planTitle: "Action Plan", timelineTitle: "Timeline", p1: "PRIORITY 1", p1Title: "Price Adj", p2: "PRIORITY 2", p2Title: "Negotiation", p3: "PRIORITY 3", p3Title: "Mix Opt", ctrl: "CONTROL", ctrlTitle: "Monitoring", warnTitle: "Consequences", warnDesc: "Risk of unviability.", marketProjTitle: "Market Projections 2026", marketProjSub: "Global Trends", marketContext: "Volatility expected.", marketSources: [{name: "World Bank", items: ["Est. decrease Arabica"]}, {name: "WalletInvestor", items: ["Upward trend"]}, {name: "Rabobank", items: ["Stabilization"]}], marketConclTitle: "Conclusion", marketConclDesc: "Preventive adjustments recommended.", steps: [{t:"Base increase",d:"Recover margin"},{t:"Staggered strategy",l:["Immediate","30 days"]}], time: {w1:"Wk 1-2", prep:"Prep", l1:["Cost analysis"], w3:"Wk 3-4", exec:"Exec", l2:["Comm"], m2:"Month 2", imp:"Imp", l3:["Increases"], m3:"Month 3", eval:"Eval", l4:["Adjust"]}}
            }
        };

        // 3. UTILS
        const formatCurrency = (val, lang = 'es', currency = 'MXN') => {
            const rate = EXCHANGE_RATES[currency] || 1;
            const convertedVal = val * rate;
            let locale = lang === 'en' ? 'en-US' : (lang === 'fr' ? 'fr-FR' : 'es-MX');
            return new Intl.NumberFormat(locale, { style: 'currency', currency: currency }).format(convertedVal);
        };
        const formatNumber = (val, lang = 'es') => {
            let locale = lang === 'en' ? 'en-US' : (lang === 'fr' ? 'fr-FR' : 'es-MX');
            return new Intl.NumberFormat(locale, { maximumFractionDigits: 2 }).format(val);
        };
        const parseDate = (dateStr) => {
            if (!dateStr) return new Date();
            let s = String(dateStr); if (s.includes('T')) s = s.split('T')[0];
            const parts = s.split('-');
            if (parts.length === 3) return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            return new Date(dateStr);
        };

        // 4. SUB-COMPONENTS
        const NavButton = ({ id, label, icon, active, set }) => (
            <button onClick={() => set(id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-left ${active === id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                <Icon name={icon} className="w-5 h-5 flex-shrink-0" /><span className="font-medium text-sm">{label}</span>
            </button>
        );

        const KPICard = ({ title, value, subValue, icon, isPositive }) => (
            <div className="metric-card">
                <div className="z-10 relative">
                    <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{title}</p><h3 className="text-2xl font-bold text-gray-800">{value}</h3>
                    {subValue && <div className={`flex items-center gap-1 mt-2 text-xs font-bold ${isPositive ? 'text-green-600' : 'text-red-500'}`}><span>{isPositive ? '‚Üë' : '‚Üì'}</span><span>{subValue}</span></div>}
                </div>
                <div className={`p-3 rounded-lg flex-shrink-0 absolute top-4 right-4 ${isPositive === false ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-600'}`}><Icon name={icon} className="w-6 h-6" /></div>
            </div>
        );

        const InsightBox = ({ title, insights }) => (
            <div className="insight-box mt-8">
                <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="dashboard" className="w-5 h-5 text-blue-500" />{title}</h4>
                <ul className="space-y-3">{insights.map((insight, idx) => <li key={idx} className="flex items-start gap-3 text-sm text-slate-600"><span className="w-1.5 h-1.5 rounded-full bg-slate-300 mt-2 flex-shrink-0"></span>{insight}</li>)}</ul>
            </div>
        );

        const MarginLostExplanation = ({ t, lang, currency }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            return (
                <div className="mt-6 mb-6">
                    <button onClick={() => setIsExpanded(!isExpanded)} className="w-full flex items-center justify-between bg-blue-50 hover:bg-blue-100 p-4 rounded-xl border border-blue-200 transition-all group">
                        <div className="flex items-center gap-3"><div className="p-2 bg-blue-500 rounded-full text-white"><Icon name="chart" className="w-5 h-5"/></div><span className="font-bold text-blue-800 text-lg">{t.strat.lostMarginExp}</span></div>
                        <Icon name={isExpanded ? "chevronUp" : "chevronDown"} className="w-5 h-5 text-blue-600" />
                    </button>
                    {isExpanded && (
                        <div className="mt-3 p-6 bg-gradient-to-br from-sky-50 to-white border-l-[6px] border-sky-600 rounded-r-xl shadow-inner animate-fade-in">
                            <h3 className="text-xl font-bold text-sky-900 mb-4 flex items-center gap-2">{t.strat.lostMarginTitle.replace('$4.39M', formatCurrency(4390000, lang, currency))}</h3>
                            <p className="text-sky-800 mb-6 font-medium text-lg leading-relaxed">{t.strat.lostMarginDesc}</p>
                            <div className="grid md:grid-cols-2 gap-8 mb-8">
                                <div className="bg-white p-5 rounded-lg shadow-sm border border-sky-100">
                                    <h4 className="font-bold text-gray-700 mb-3 border-b pb-2">{t.strat.lostMarginStep1}</h4><p className="text-sm text-gray-600 font-mono">{t.strat.lostMarginStep1Desc}</p>
                                    <h4 className="font-bold text-gray-700 mt-4 mb-3 border-b pb-2">{t.strat.lostMarginStep2}</h4><p className="text-sm text-gray-600 font-mono">{t.strat.lostMarginStep2Desc}</p>
                                    <h4 className="font-bold text-red-600 mt-4 mb-3 border-b border-red-100 pb-2">{t.strat.lostMarginStep3}</h4><p className="text-lg font-bold text-red-600 font-mono">{t.strat.lostMarginStep3Desc}</p>
                                </div>
                                <div className="flex flex-col justify-center">
                                    <div className="mb-6"><div className="flex justify-between text-sm font-bold text-gray-600 mb-1"><span>{t.strat.lostMarginViz1}</span><span>{formatCurrency(16920000, lang, currency)}</span></div><div className="w-full bg-gray-200 rounded-full h-6"><div className="bg-green-500 h-6 rounded-full" style={{width: '100%'}}></div></div></div>
                                    <div className="mb-2"><div className="flex justify-between text-sm font-bold text-gray-600 mb-1"><span>{t.strat.lostMarginViz2}</span><span>{formatCurrency(12530000, lang, currency)}</span></div><div className="w-full bg-gray-200 rounded-full h-6 relative"><div className="bg-red-500 h-6 rounded-l-full absolute top-0 left-0" style={{width: '74%'}}></div><div className="h-6 absolute top-0 right-0 border-l-2 border-dashed border-gray-400 flex items-center justify-center text-xs text-gray-500 font-bold" style={{width: '26%'}}>{t.strat.lostMarginVizGap}: {formatCurrency(4390000, lang, currency)}</div></div></div>
                                </div>
                            </div>
                            <div className="bg-sky-100 p-4 rounded-lg border border-sky-200 text-sky-800 text-sm font-medium italic">{t.strat.lostMarginFinal}</div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. VIEW COMPONENTS
        const DashboardView = ({ data, t, lang, currency }) => {
            const { totals, monthly, clients } = data;
            const salesGrowthPct = totals.sales2024 > 0 ? ((totals.sales2025 - totals.sales2024) / totals.sales2024) * 100 : 0;
            const kgGrowthPct = totals.kg2024 > 0 ? ((totals.kg2025 - totals.kg2024) / totals.kg2024) * 100 : 0;
            const marginDiff = totals.avgMarginPerKg2025 - totals.avgMarginPerKg2024;
            const profitGrowthPct = totals.profit2024 > 0 ? ((totals.profit2025 - totals.profit2024) / totals.profit2024) * 100 : 0;
            const marginDiffText = `${marginDiff >= 0 ? '+' : ''}${formatCurrency(marginDiff, lang, currency)}`;

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KPICard title={`${t.kpis.totalRevenue} 2025`} value={formatCurrency(totals.sales2025, lang, currency)} subValue={`${salesGrowthPct.toFixed(1)}%`} isPositive={salesGrowthPct > 0} icon="dollar" />
                        <KPICard title={`${t.kpis.totalKg} 2025`} value={`${formatNumber(totals.kg2025, lang)} kg`} subValue={`${kgGrowthPct.toFixed(1)}%`} isPositive={kgGrowthPct > 0} icon="scale" />
                        <KPICard title={t.kpis.avgMargin} value={formatCurrency(totals.avgMarginPerKg2025, lang, currency)} subValue={marginDiffText} isPositive={marginDiff >= 0} icon="chart" />
                        <KPICard title={t.kpis.totalProfit} value={formatCurrency(totals.profit2025, lang, currency)} subValue={`${profitGrowthPct.toFixed(1)}%`} isPositive={profitGrowthPct > 0} icon="trendingUp" />
                    </div>
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-6">{t.charts.monthlyRevenue}</h3>
                            <div className="h-72"><ResponsiveContainer><LineChart data={monthly}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name"/><YAxis tickFormatter={(v) => formatNumber(v * (EXCHANGE_RATES[currency] || 1) / 1000, lang) + 'k'}/><Tooltip formatter={(v)=>formatCurrency(v,lang, currency)}/><Legend/><Line type="monotone" dataKey="sales2024" stroke={COLORS.year2024}/><Line type="monotone" dataKey="sales2025" stroke={COLORS.year2025}/></LineChart></ResponsiveContainer></div>
                        </div>
                        <div className="w-full lg:w-2/5 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-6">{t.charts.topClients}</h3>
                            <div className="overflow-x-auto"><table className="w-full text-xs md:text-sm text-left text-gray-500"><thead className="text-xs text-gray-700 uppercase bg-gray-50"><tr><th className="px-3 py-2 rounded-l-lg">{t.table.client}</th><th className="px-3 py-2 text-right">{t.table.sale}</th><th className="px-3 py-2 text-right rounded-r-lg">{t.table.growth}</th></tr></thead><tbody>{clients.slice(0, 5).map((client, idx) => { const growth = client.sales2024 > 0 ? ((client.sales2025 - client.sales2024) / client.sales2024) * 100 : 100; return (<tr key={idx} className="border-b hover:bg-gray-50"><td className="px-3 py-2 font-medium text-gray-900 text-xs md:text-sm whitespace-normal break-words" title={client.name}>{client.name}</td><td className="px-3 py-2 text-right">{formatCurrency(client.sales2025, lang, currency)}</td><td className={`px-3 py-2 text-right font-bold ${growth >= 0 ? 'text-green-600' : 'text-red-500'}`}>{growth >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(growth).toFixed(0)}%</td></tr>); })}</tbody></table></div>
                        </div>
                    </div>
                    <InsightBox title={t.obs.general} insights={[`${t.kpis.growthRevenue}: ${salesGrowthPct.toFixed(1)}% ${t.common.vs} 2024.`]} />
                </div>
            );
        };

        const GrowthView = ({ data, t, lang, currency }) => {
            const { monthly, totals } = data;
            const quarters = [{name:'Q1',months:[0,1,2]},{name:'Q2',months:[3,4,5]},{name:'Q3',months:[6,7,8]},{name:'Q4',months:[9,10,11]}].map(q => { const s24=q.months.reduce((a,m)=>a+monthly[m].sales2024,0); const s25=q.months.reduce((a,m)=>a+monthly[m].sales2025,0); return {name:q.name,sales2024:s24,sales2025:s25,pct:s24>0?((s25-s24)/s24)*100:0}; });
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><KPICard title={t.kpis.growthRevenue} value={formatCurrency(totals.sales2025 - totals.sales2024, lang, currency)} isPositive={true} icon="dollar" /><KPICard title={t.kpis.growthVol} value={`${formatNumber(totals.kg2025 - totals.kg2024, lang)} kg`} isPositive={true} icon="scale" /></div>
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-4">{t.charts.monthlyComp}</h3><div className="h-64"><ResponsiveContainer><BarChart data={monthly}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name"/><YAxis tickFormatter={(v) => formatNumber(v * (EXCHANGE_RATES[currency] || 1) / 1000, lang) + 'k'}/><Tooltip formatter={(v)=>formatCurrency(v,lang, currency)}/><Bar dataKey="sales2024" fill={COLORS.year2024}/><Bar dataKey="sales2025" fill={COLORS.year2025}/></BarChart></ResponsiveContainer></div></div>
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-4">{t.charts.quarterly}</h3><table className="w-full text-xs md:text-sm"><thead className="bg-gray-50 text-gray-600"><tr><th className="px-3 py-2 text-left">{t.table.q}</th><th className="px-3 py-2 text-right">2024</th><th className="px-3 py-2 text-right">2025</th><th className="px-3 py-2 text-right">{t.table.change}</th></tr></thead><tbody>{quarters.map((q,i)=>(<tr key={i} className="border-b"><td className="px-3 py-2 font-medium">{q.name}</td><td className="px-3 py-2 text-right">{formatCurrency(q.sales2024,lang, currency)}</td><td className="px-3 py-2 text-right">{formatCurrency(q.sales2025,lang, currency)}</td><td className={`px-3 py-2 text-right font-bold ${q.pct>=0?'text-green-600':'text-red-500'}`}>{q.pct.toFixed(1)}%</td></tr>))}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const MarginView = ({ data, t, lang, currency }) => {
            const { monthly, totals } = data;
            const [selectedYear, setSelectedYear] = useState('2025');
            const marginChange = totals.avgMarginPerKg2025 - totals.avgMarginPerKg2024;
            const marginPctChange = totals.marginPct2025 - totals.marginPct2024;
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <KPICard title={t.kpis.avgMargin} value={formatCurrency(totals.avgMarginPerKg2025, lang, currency)} subValue={formatCurrency(marginChange, lang, currency)} isPositive={marginChange >= 0} icon="dollar" />
                        <KPICard title={t.kpis.marginPct} value={`${totals.marginPct2025.toFixed(1)}%`} subValue={`${marginPctChange.toFixed(1)}%`} isPositive={marginPctChange >= 0} icon="chart" />
                        <KPICard title={t.kpis.totalProfit} value={formatCurrency(totals.profit2025, lang, currency)} isPositive={true} icon="trendingUp" />
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-gray-700">{t.charts.priceVsCost}</h3><div className="flex bg-gray-100 rounded-lg p-1"><button onClick={()=>setSelectedYear('2024')} className={`px-3 py-1 text-xs font-bold rounded-md ${selectedYear==='2024'?'bg-white shadow text-blue-600':''}`}>2024</button><button onClick={()=>setSelectedYear('2025')} className={`px-3 py-1 text-xs font-bold rounded-md ${selectedYear==='2025'?'bg-white shadow text-purple-600':''}`}>2025</button></div></div><div className="h-80"><ResponsiveContainer><AreaChart data={monthly}><defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={selectedYear==='2025'?COLORS.year2025:COLORS.year2024} stopOpacity={0.2}/><stop offset="95%" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name"/><YAxis tickFormatter={(v)=>formatNumber(v * (EXCHANGE_RATES[currency] || 1), lang)}/><Tooltip formatter={(v)=>formatCurrency(v,lang, currency)}/><Area type="monotone" dataKey={`avgCost${selectedYear}`} stroke="#ef4444" fill="transparent" strokeDasharray="5 5"/><Area type="monotone" dataKey={`avgPrice${selectedYear}`} stroke={selectedYear==='2025'?COLORS.year2025:COLORS.year2024} fill="url(#g)"/></AreaChart></ResponsiveContainer></div></div>
                </div>
            );
        };

        const CustomersView = ({ rawData, t, lang, isPdfMode, currency }) => {
            const [selectedYears, setSelectedYears] = useState(['2024']);
            const [startMonth, setStartMonth] = useState(0);
            const [endMonth, setEndMonth] = useState(11);
            const [groupBy, setGroupBy] = useState('fiscal_id');
            const [sortConfig, setSortConfig] = useState({ key: 'profit', direction: 'desc' });
            const [othersExpanded, setOthersExpanded] = useState(false);
            
            const handleSort = (key) => setSortConfig({ key, direction: sortConfig.key === key && sortConfig.direction === 'desc' ? 'asc' : 'desc' });
            const getSortIcon = (key) => sortConfig.key !== key ? <span className="ml-1 text-gray-300">‚Üï</span> : (sortConfig.direction === 'asc' ? <span className="ml-1 text-blue-600">‚Üë</span> : <span className="ml-1 text-blue-600">‚Üì</span>);
            const toggleYear = (year) => { if (selectedYears.includes(year)) { if (selectedYears.length > 1) setSelectedYears(selectedYears.filter(y => y !== year)); } else { setSelectedYears([...selectedYears, year]); } };

            const { customerData, summary, othersData } = useMemo(() => {
                const grouped = {};
                let totalFilteredProfit = 0;
                rawData.forEach(item => {
                    const date = parseDate(item.invoice_date);
                    const year = String(date.getFullYear());
                    const month = date.getMonth();
                    if (!selectedYears.includes(year)) return;
                    if (month < startMonth || month > endMonth) return;
                    let key = groupBy === 'fiscal_id' ? (item.client_fiscal_id || "N/A") : (item.client_location || "N/A");
                    if (!grouped[key]) grouped[key] = { name: key, totalRevenue: 0, totalCost: 0, totalKg: 0, invoiceCount: new Set() };
                    const sale = parseFloat(String(item.item_sale).replace(/[$,]/g, '')) || 0;
                    const cost = parseFloat(String(item.coffee_total_cost).replace(/[$,]/g, '')) || 0;
                    const kg = parseFloat(String(item.item_coffee_weight_sum).replace(/[$,]/g, '')) || 0;
                    grouped[key].totalRevenue += sale; grouped[key].totalCost += cost; grouped[key].totalKg += kg;
                    if(item.invoice_number) grouped[key].invoiceCount.add(item.invoice_number);
                });
                const allCustomers = Object.values(grouped).map(g => ({ ...g, profit: g.totalRevenue - g.totalCost }));
                totalFilteredProfit = allCustomers.reduce((acc, c) => acc + c.profit, 0);
                const main = []; const others = [];
                let othersAgg = { name: t.table.others, totalRevenue: 0, totalCost: 0, totalKg: 0, profit: 0, invoiceCount: 0, isOthers: true };
                allCustomers.forEach(c => {
                    const avgPricePerKg = c.totalKg > 0 ? c.totalRevenue / c.totalKg : 0;
                    const marginPct = c.totalRevenue > 0 ? (c.profit / c.totalRevenue) * 100 : 0;
                    const uniqueInvoices = c.invoiceCount.size || 1;
                    const avgVolPerInvoice = c.totalKg / uniqueInvoices;
                    const contribPct = totalFilteredProfit !== 0 ? (c.profit / totalFilteredProfit) * 100 : 0;
                    const enriched = { ...c, avgPricePerKg, marginPct, avgVolPerInvoice, contribPct };
                    if (c.totalKg < 20) { others.push(enriched); othersAgg.totalRevenue += c.totalRevenue; othersAgg.totalCost += c.totalCost; othersAgg.totalKg += c.totalKg; othersAgg.profit += c.profit; othersAgg.invoiceCount += uniqueInvoices; } else { main.push(enriched); }
                });
                if (others.length > 0) { othersAgg.avgPricePerKg = othersAgg.totalKg > 0 ? othersAgg.totalRevenue / othersAgg.totalKg : 0; othersAgg.marginPct = othersAgg.totalRevenue > 0 ? (othersAgg.profit / othersAgg.totalRevenue) * 100 : 0; othersAgg.avgVolPerInvoice = othersAgg.totalKg / (othersAgg.invoiceCount || 1); othersAgg.contribPct = totalFilteredProfit !== 0 ? (othersAgg.profit / totalFilteredProfit) * 100 : 0; main.push(othersAgg); }
                main.sort((a,b) => { if (a.isOthers) return 1; if (b.isOthers) return -1; const valA = a[sortConfig.key], valB = b[sortConfig.key]; if (sortConfig.key === 'name') return sortConfig.direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA)); return sortConfig.direction === 'asc' ? valA - valB : valB - valA; });
                return { customerData: main, othersData: others.sort((a,b) => b.profit - a.profit), summary: { revenue: allCustomers.reduce((acc, c) => acc + c.totalRevenue, 0), profit: totalFilteredProfit, kg: allCustomers.reduce((acc, c) => acc + c.totalKg, 0) } };
            }, [rawData, selectedYears, startMonth, endMonth, groupBy, sortConfig, t]);

            return (
                <div className="space-y-6 animate-fade-in">
                    {!isPdfMode && (<div className="flex flex-wrap gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 items-center justify-between"><div className="flex items-center bg-gray-200 rounded-lg p-1"><button onClick={() => setGroupBy('fiscal_id')} className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${groupBy === 'fiscal_id' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{t.common.fiscalId}</button><button onClick={() => setGroupBy('location')} className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${groupBy === 'location' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{t.common.location}</button></div><div className="flex flex-wrap gap-4 items-center"><div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-200"><span className="text-sm text-gray-500 font-medium">{t.common.year}:</span><div className="flex gap-1">{['2024', '2025'].map(year => (<button key={year} onClick={() => toggleYear(year)} className={`px-3 py-1 text-xs font-bold rounded border transition-colors ${selectedYears.includes(year) ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100'}`}>{year}</button>))}</div></div><div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-200"><span className="text-sm text-gray-500 font-medium">Meses:</span><select value={startMonth} onChange={(e) => { const val = parseInt(e.target.value); setStartMonth(val); if (val > endMonth) setEndMonth(val); }} className="bg-gray-50 border border-gray-300 text-gray-700 text-xs rounded focus:ring-blue-500 focus:border-blue-500 p-1.5">{MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select><span className="text-gray-400">-</span><select value={endMonth} onChange={(e) => { const val = parseInt(e.target.value); setEndMonth(val); if (val < startMonth) setStartMonth(val); }} className="bg-gray-50 border border-gray-300 text-gray-700 text-xs rounded focus:ring-blue-500 focus:border-blue-500 p-1.5">{MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select></div></div></div>)}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><KPICard title={t.kpis.profitability} value={formatCurrency(summary.profit, lang, currency)} isPositive={true} icon="trendingUp" /><KPICard title={t.kpis.totalRevenue} value={formatCurrency(summary.revenue, lang, currency)} isPositive={true} icon="dollar" /><KPICard title={t.kpis.totalKg} value={`${formatNumber(summary.kg, lang)} kg`} isPositive={true} icon="scale" /></div>
                    <div className="bg-white p-6 rounded-xl shadow-sm overflow-x-auto"><table className="w-full text-xs md:text-sm text-left"><thead className="bg-slate-50 text-slate-700 uppercase"><tr><th onClick={()=>handleSort('name')} className="px-4 py-3 cursor-pointer hover:bg-slate-100">{groupBy==='fiscal_id'?t.table.client:t.table.branch} {getSortIcon('name')}</th><th onClick={()=>handleSort('totalRevenue')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.sale} {getSortIcon('totalRevenue')}</th><th onClick={()=>handleSort('profit')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.profit} {getSortIcon('profit')}</th><th onClick={()=>handleSort('contribPct')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.contribution} {getSortIcon('contribPct')}</th><th onClick={()=>handleSort('marginPct')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.marginPct} {getSortIcon('marginPct')}</th><th onClick={()=>handleSort('totalKg')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.totalVol} {getSortIcon('totalKg')}</th><th onClick={()=>handleSort('avgVolPerInvoice')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.avgVol} {getSortIcon('avgVolPerInvoice')}</th></tr></thead><tbody>{customerData.map((row,i) => (<React.Fragment key={i}><tr className={`border-b hover:bg-gray-50 ${row.isOthers ? 'bg-gray-50 italic cursor-pointer' : ''}`} onClick={row.isOthers ? () => setOthersExpanded(!othersExpanded) : undefined}><td className="px-4 py-2 font-medium whitespace-normal break-words min-w-[150px]" title={row.name}>{row.isOthers && <span className="mr-2">{othersExpanded ? '‚ñº' : '‚ñ∂'}</span>}{row.name}</td><td className="px-4 py-2 text-right">{formatCurrency(row.totalRevenue, lang, currency)}</td><td className="px-4 py-2 text-right text-green-600 font-bold">{formatCurrency(row.profit, lang, currency)}</td><td className="px-4 py-2 text-right">{row.contribPct.toFixed(1)}%</td><td className="px-4 py-2 text-right">{row.marginPct.toFixed(1)}%</td><td className="px-4 py-2 text-right">{formatNumber(row.totalKg, lang)}</td><td className="px-4 py-2 text-right">{formatNumber(row.avgVolPerInvoice, lang)}</td></tr>{row.isOthers && othersExpanded && othersData.map((sub, j) => (<tr key={`sub-${j}`} className="border-b bg-gray-50/50 text-gray-500 text-xs"><td className="px-4 py-1 pl-8 truncate">{sub.name}</td><td className="px-4 py-1 text-right">{formatCurrency(sub.totalRevenue, lang, currency)}</td><td className="px-4 py-1 text-right">{formatCurrency(sub.profit, lang, currency)}</td><td className="px-4 py-1 text-right">{sub.contribPct.toFixed(2)}%</td><td className="px-4 py-1 text-right">{sub.marginPct.toFixed(1)}%</td><td className="px-4 py-1 text-right">{formatNumber(sub.totalKg, lang)}</td><td className="px-4 py-1 text-right">{formatNumber(sub.avgVolPerInvoice, lang)}</td></tr>))}</React.Fragment>))}</tbody></table></div>
                    <InsightBox title={t.obs.customers} insights={[`Top Cliente: ${customerData.length > 0 ? customerData[0].name : 'N/A'} con ${formatCurrency(customerData.length > 0 ? customerData[0].profit : 0, lang, currency)} de beneficio.`, `Total procesado: ${formatNumber(summary.kg, lang)} kg.`]} />
                </div>
            );
        };

        const AnalysisView = ({ t, lang, currency }) => {
            const chart1Ref = useRef(null); const chart2Ref = useRef(null);

            useEffect(() => {
                const charts = [];
                const rate = EXCHANGE_RATES[currency] || 1;
                const datosMensuales = { 2024: { meses: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'], precio: [298.35, 284.85, 295.42, 286.2, 290.14, 293.09, 289.25, 286.07, 286.11, 286.16, 292.19, 295.89], costo: [116.64, 113.25, 113.31, 114.48, 114.74, 113.4, 113.38, 115.2, 113.02, 114.37, 116.05, 114.55] }, 2025: { precio: [304.86, 312.17, 311.82, 313.88, 326.22, 314.48, 327.47, 321.36, 321.65, 320.39, 321.45, 322.98], costo: [177.56, 175.9, 177.71, 174.99, 176.75, 175.26, 175.47, 177.81, 175.93, 176.27, 178.46, 177.47] } };
                const p24 = datosMensuales[2024].precio.map(v => v * rate);
                const c24 = datosMensuales[2024].costo.map(v => v * rate);
                const p25 = datosMensuales[2025].precio.map(v => v * rate);
                const c25 = datosMensuales[2025].costo.map(v => v * rate);

                if (chart1Ref.current) { charts.push(new Chart(chart1Ref.current, { type: 'line', data: { labels: datosMensuales[2024].meses, datasets: [{ label: t.common.price + ' 2024', data: p24, borderColor: '#4169E1', backgroundColor: 'rgba(65, 105, 225, 0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }, { label: t.common.cost + ' 2024', data: c24, borderColor: '#fb8500', backgroundColor: 'rgba(251, 133, 0, 0.1)', borderWidth: 2, borderDash: [5, 5], tension: 0.4, fill: true, pointRadius: 0 }, { label: t.common.price + ' 2025', data: p25, borderColor: '#7b2cbf', backgroundColor: 'rgba(123, 44, 191, 0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 0 }, { label: t.common.cost + ' 2025', data: c25, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', borderWidth: 3, borderDash: [5, 5], tension: 0.4, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { ticks: { callback: (v) => formatNumber(v, lang) } } } } })); }
                if (chart2Ref.current) { charts.push(new Chart(chart2Ref.current, { type: 'bar', data: { labels: ['Grano', 'Filtro', 'Espresso', 'Cold Brew'], datasets: [{ label: '2024', data: [65.9, 63.8, 86.8, 86.9], backgroundColor: 'rgba(34, 197, 94, 0.7)' }, { label: '2025', data: [45.6, 45.1, 45.8, 50.5], backgroundColor: 'rgba(220, 38, 38, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } })); }
                return () => charts.forEach(c => c.destroy());
            }, [lang, currency]);

            return (
                <div className="strat-view animate-fade-in"><div className="container-like"><div className="alert-banner"><h2>{t.strat.alertTitle}</h2><p>{t.strat.alertDesc}</p><p style={{fontSize:'1em',marginTop:'10px'}}>{t.strat.alertSub}</p></div><div className="metrics-grid"><div className="metric-card purple"><div className="metric-label">{t.strat.kpi1}</div><div className="metric-value">{formatCurrency(144.90, lang, currency)}</div><div className="metric-change negative">{t.strat.kpi1Sub.replace('$34.08', formatCurrency(34.08, lang, currency))}</div></div><div className="metric-card red"><div className="metric-label">{t.strat.kpi2}</div><div className="metric-value">45.6%</div><div className="metric-change negative">{t.strat.kpi2Sub}</div></div><div className="metric-card green"><div className="metric-label">{t.strat.kpi3}</div><div className="metric-value">{formatCurrency(12530000, lang, currency)}</div><div className="metric-change negative">{t.strat.kpi3Sub}</div></div><div className="metric-card orange"><div className="metric-label">{t.strat.kpi4}</div><div className="metric-value">{formatCurrency(4390000, lang, currency)}</div><div className="metric-change negative">{t.strat.kpi4Sub.replace('$366K', formatCurrency(366000, lang, currency))}</div></div></div><MarginLostExplanation t={t} lang={lang} currency={currency} /><div className="chart-container"><div className="chart-title">{t.strat.chart1Title}</div><div className="chart-wrapper"><canvas ref={chart1Ref}></canvas></div><p className="text-xs text-center text-gray-400 mt-2">{t.strat.clickToHide}</p></div><div className="table-container"><div className="chart-title">{t.strat.table1Title}</div><table><thead><tr><th>{t.table.concept}</th><th>{t.table.price}</th><th>{t.table.cost}</th><th>{t.table.marginAbs}</th><th>{t.table.marginPct}</th><th>{t.kpis.totalRevenue}</th></tr></thead><tbody><tr><td><strong>2024</strong></td><td className="number">{formatCurrency(290.61, lang, currency)}</td><td className="number">{formatCurrency(114.45, lang, currency)}</td><td className="number positive-value">{formatCurrency(176.16, lang, currency)}</td><td className="number positive-value">61.6%</td><td className="number">{formatCurrency(22100000, lang, currency)}</td></tr><tr className="highlight-row"><td><strong>2025</strong></td><td className="number">{formatCurrency(317.83, lang, currency)}</td><td className="number">{formatCurrency(176.66, lang, currency)}</td><td className="number">{formatCurrency(141.17, lang, currency)}</td><td className="number negative-value">45.6%</td><td className="number">{formatCurrency(27500000, lang, currency)}</td></tr></tbody></table></div><div className="table-container"><div className="chart-title">{t.strat.table3Title}</div><table><thead><tr><th>{t.table.variety}</th><th>{t.table.sale}</th><th>{t.table.profit}</th><th>{t.table.margin24}</th><th>{t.table.margin25}</th></tr></thead><tbody><tr><td>Main Street</td><td className="number">{formatCurrency(7420000, lang, currency)}</td><td className="number">{formatCurrency(3310000, lang, currency)}</td><td className="number positive-value">61.2%</td><td className="number">44.6%</td></tr><tr><td>Maestrale</td><td className="number">{formatCurrency(6540000, lang, currency)}</td><td className="number">{formatCurrency(3050000, lang, currency)}</td><td className="number positive-value">62.4%</td><td className="number">46.7%</td></tr><tr><td>Mezcla Americano</td><td className="number">{formatCurrency(2430000, lang, currency)}</td><td className="number">{formatCurrency(1230000, lang, currency)}</td><td className="number positive-value">62.2%</td><td className="number positive-value">50.6%</td></tr></tbody></table></div><div className="final-warning"><h3>{t.strat.warnTitle}</h3><p>{t.strat.warnDesc}</p></div></div></div>
            );
        };

        // 6. MAIN APP COMPONENT
        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [processedData, setProcessedData] = useState(null);
            const [lang, setLang] = useState('es');
            const [currency, setCurrency] = useState('MXN');
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const contentRef = useRef(null);
            const fullReportRef = useRef(null);

            useEffect(() => {
                const browserLang = navigator.language || navigator.userLanguage;
                let initialLang = 'es';
                if (browserLang.startsWith('fr')) initialLang = 'fr';
                else if (browserLang.startsWith('en')) initialLang = 'en';
                setLang(initialLang);
                if (initialLang === 'es') setCurrency('MXN'); else setCurrency('USD');
            }, []);

            const t = TRANSLATIONS[lang];

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(API_URL, { redirect: "follow" });
                        if (!response.ok) throw new Error("Network response was not ok");
                        const jsonData = await response.json();
                        let finalData = Array.isArray(jsonData) ? jsonData : jsonData.data || jsonData.items || [];
                        const normalizedData = finalData.map(item => {
                            const newItem = {};
                            Object.keys(item).forEach(key => newItem[key.toLowerCase().trim().replace(/\s+/g, '_')] = item[key]);
                            return newItem;
                        });
                        setData(normalizedData);
                        processAllData(normalizedData);
                        setLoading(false);
                    } catch (err) { console.error("Fetch Error:", err); setError(t.common.error); setLoading(false); }
                };
                fetchData();
            }, [lang]); 

            const processAllData = (rawData) => {
                const monthlyData = Array(12).fill(0).map((_, i) => ({
                    name: MONTHS[i], monthIndex: i, sales2024: 0, sales2025: 0, kg2024: 0, kg2025: 0, cost2024: 0, cost2025: 0, profit2024: 0, profit2025: 0
                }));
                const clients = {}; const recipes = {};
                let totals = { sales2024: 0, sales2025: 0, kg2024: 0, kg2025: 0, profit2024: 0, profit2025: 0 };
                rawData.forEach(item => {
                    const date = parseDate(item.invoice_date); const year = date.getFullYear(); const month = date.getMonth();
                    const parseNum = (val) => { if (typeof val === 'number') return val; if (!val) return 0; const cleanStr = String(val).replace(/[$,]/g, ''); return isNaN(parseFloat(cleanStr)) ? 0 : parseFloat(cleanStr); };
                    const sale = parseNum(item.item_sale); const kg = parseNum(item.item_coffee_weight_sum); const totalCost = parseNum(item.coffee_total_cost); const profit = sale - totalCost;
                    const clientId = item.client_fiscal_id || "Desconocido"; const recipeId = item.item_recipe || "Generico";
                    if (!clients[clientId]) clients[clientId] = { name: clientId, sales2024: 0, sales2025: 0 };
                    if (!recipes[recipeId]) recipes[recipeId] = { name: recipeId, kg2024: 0, kg2025: 0, profit2025: 0, sales2025: 0 };
                    if (year === 2024) { monthlyData[month].sales2024 += sale; monthlyData[month].kg2024 += kg; monthlyData[month].cost2024 += totalCost; monthlyData[month].profit2024 += profit; totals.sales2024 += sale; totals.kg2024 += kg; totals.profit2024 += profit; clients[clientId].sales2024 += sale; recipes[recipeId].kg2024 += kg; }
                    else if (year === 2025) { monthlyData[month].sales2025 += sale; monthlyData[month].kg2025 += kg; monthlyData[month].cost2025 += totalCost; monthlyData[month].profit2025 += profit; totals.sales2025 += sale; totals.kg2025 += kg; totals.profit2025 += profit; clients[clientId].sales2025 += sale; recipes[recipeId].kg2025 += kg; recipes[recipeId].profit2025 += profit; recipes[recipeId].sales2025 += sale; }
                });
                monthlyData.forEach(m => { m.avgPrice2024 = m.kg2024 > 0 ? m.sales2024 / m.kg2024 : 0; m.avgCost2024 = m.kg2024 > 0 ? m.cost2024 / m.kg2024 : 0; m.avgPrice2025 = m.kg2025 > 0 ? m.sales2025 / m.kg2025 : 0; m.avgCost2025 = m.kg2025 > 0 ? m.cost2025 / m.kg2025 : 0; });
                totals.avgMarginPerKg2024 = totals.kg2024 > 0 ? totals.profit2024 / totals.kg2024 : 0; totals.avgMarginPerKg2025 = totals.kg2025 > 0 ? totals.profit2025 / totals.kg2025 : 0;
                totals.marginPct2024 = totals.sales2024 > 0 ? (totals.profit2024 / totals.sales2024) * 100 : 0; totals.marginPct2025 = totals.sales2025 > 0 ? (totals.profit2025 / totals.sales2025) * 100 : 0;
                setProcessedData({ monthly: monthlyData, clients: Object.values(clients).sort((a,b) => b.sales2025 - a.sales2025), recipes: Object.values(recipes).sort((a,b) => b.kg2025 - a.kg2025), totals: totals });
            };

            const generatePdfFromElement = async (element, filename) => {
                const originalWidth = element.style.width; element.style.width = '1200px'; 
                try {
                    const canvas = await html2canvas(element, { scale: 1.5, useCORS: true, logging: false, windowWidth: 1200, backgroundColor: '#f8fafc' });
                    const imgData = canvas.toDataURL('image/png'); const pdf = new jspdf.jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                    const imgProps = pdf.getImageProperties(imgData); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; const pageHeight = pdf.internal.pageSize.getHeight();
                    let heightLeft = pdfHeight, position = 0; pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight); heightLeft -= pageHeight;
                    while (heightLeft >= 0) { position = heightLeft - pdfHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight); heightLeft -= pageHeight; }
                    pdf.save(filename);
                } catch (e) { console.error("PDF Error", e); } finally { element.style.width = originalWidth; }
            };

            const handleDownloadFullReport = async () => { setIsGeneratingPdf(true); await new Promise(r => setTimeout(r, 2500)); if (fullReportRef.current) await generatePdfFromElement(fullReportRef.current, `Informe_Completo_Ventas.pdf`); setIsGeneratingPdf(false); };
            const toggleLang = () => setLang(prev => { const n = prev === 'es' ? 'en' : (prev === 'en' ? 'fr' : 'es'); if (n === 'es') setCurrency('MXN'); else setCurrency('USD'); return n; });

            if (loading) return <div className="flex h-screen items-center justify-center bg-gray-50"><div className="text-center"><Icon name="loader" className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-4" /><h2 className="text-xl font-semibold text-gray-700">{t.common.loading}</h2></div></div>;
            if (error || !processedData) return <div className="p-10 text-red-600 text-center">{error}</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20 hidden md:flex">
                        <div className="p-6 border-b border-slate-800 text-center">
                            <img src="assets/whitelabel.png" alt="Logo" className="h-12 mx-auto mb-3 object-contain" onError={(e) => {e.target.style.display='none'; e.target.nextSibling.style.display='block'}} />
                            <h1 style={{display:'none'}} className="text-xl font-bold tracking-tight text-blue-400 uppercase leading-tight">SSC GOURMET</h1>
                            <p className="text-xs text-slate-400 mt-2">{t.subtitle}</p>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <NavButton id="dashboard" label={t.tabs.dashboard} icon="dashboard" active={activeTab} set={setActiveTab} />
                            <NavButton id="growth" label={t.tabs.growth} icon="trendingUp" active={activeTab} set={setActiveTab} />
                            <NavButton id="margin" label={t.tabs.margin} icon="dollar" active={activeTab} set={setActiveTab} />
                            <NavButton id="customers" label={t.tabs.customers} icon="users" active={activeTab} set={setActiveTab} />
                            <NavButton id="analysis" label={t.tabs.analysis} icon="alert" active={activeTab} set={setActiveTab} />
                        </nav>
                        <div className="p-4 border-t border-slate-800 space-y-4">
                            <div className="flex justify-between bg-slate-800 rounded p-1">
                                {['es', 'en', 'fr'].map(l => (<button key={l} onClick={() => { setLang(l); if (l === 'es') setCurrency('MXN'); else setCurrency('USD'); }} className={`px-3 py-1 text-xs font-bold rounded transition-colors ${lang === l ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>{l.toUpperCase()}</button>))}
                            </div>
                            <div>
                                <p className="text-[10px] text-slate-500 uppercase tracking-wider mb-2 font-bold">{t.common.currency}</p>
                                <div className="flex justify-between bg-slate-800 rounded p-1">
                                    {['MXN', 'USD', 'EUR'].map(c => (<button key={c} onClick={() => setCurrency(c)} className={`px-2 py-1 text-xs font-bold rounded transition-colors ${currency === c ? 'bg-green-600 text-white' : 'text-slate-400 hover:text-white'}`}>{c}</button>))}
                                </div>
                                <p className="text-[10px] text-slate-500 mt-2 text-right">{t.common.exchangeRate}: 1 {currency} = { (1/EXCHANGE_RATES[currency]).toFixed(2) } MXN</p>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-800 text-[10px] text-slate-500 text-center font-bold tracking-wider">{t.footer}</div>
                    </aside>

                    <div className="md:hidden fixed top-0 w-full bg-slate-900 text-white z-30 p-4 flex justify-between items-center shadow-md"><span className="font-bold">SSC Gourmet</span><div className="flex gap-2"><button onClick={toggleLang} className="text-xs bg-slate-800 px-2 py-1 rounded">{lang.toUpperCase()}</button></div></div>
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 z-30 flex justify-around p-2">
                         {['dashboard','growth','margin','customers','analysis'].map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`p-2 rounded-full ${activeTab === tab ? 'bg-blue-100 text-blue-600' : 'text-gray-500'}`}><Icon name={tab === 'analysis' ? 'alert' : (tab === 'customers' ? 'users' : (tab === 'margin' ? 'dollar' : (tab === 'growth' ? 'trendingUp' : 'dashboard')))} className="w-6 h-6"/></button>))}
                    </div>

                    <main className="flex-1 overflow-y-auto bg-gray-50 relative pt-16 md:pt-0 pb-16 md:pb-0" ref={contentRef}>
                        <div className="max-w-7xl mx-auto p-4 md:p-8">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                <div><h2 className="text-2xl md:text-3xl font-bold text-slate-800">{activeTab === 'analysis' ? t.strat.mainTitle : t.tabs[activeTab]}</h2><p className="text-slate-500 mt-1 text-sm">{t.tabDesc[activeTab]}</p></div>
                                <div className="flex gap-2"><button onClick={handleDownloadFullReport} disabled={isGeneratingPdf} className="hide-on-pdf flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition-all text-sm font-medium disabled:opacity-50">{isGeneratingPdf ? <Icon name="loader" className="w-4 h-4 animate-spin"/> : <Icon name="fileText" className="w-4 h-4" />}{isGeneratingPdf ? t.common.generating : t.common.downloadFull}</button></div>
                            </div>
                            {activeTab === 'dashboard' && <DashboardView data={processedData} t={t} lang={lang} currency={currency} />}
                            {activeTab === 'growth' && <GrowthView data={processedData} t={t} lang={lang} currency={currency} />}
                            {activeTab === 'margin' && <MarginView data={processedData} t={t} lang={lang} currency={currency} />}
                            {activeTab === 'customers' && <CustomersView rawData={data} t={t} lang={lang} currency={currency} />}
                            {activeTab === 'analysis' && <AnalysisView t={t} lang={lang} currency={currency} />}
                        </div>
                    </main>

                    {isGeneratingPdf && (
                        <div ref={fullReportRef} className="pdf-mode">
                            <div className="mb-8 border-b pb-4"><h1 className="text-3xl font-bold text-slate-900">{t.title}</h1><p className="text-slate-500">{t.subtitle} - {t.footer}</p><p className="text-sm text-slate-400 mt-1">{new Date().toLocaleDateString()}</p></div>
                            <div className="mb-8"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.dashboard}</h2><DashboardView data={processedData} t={t} lang={lang} currency={currency} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.growth}</h2><GrowthView data={processedData} t={t} lang={lang} currency={currency} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.margin}</h2><MarginView data={processedData} t={t} lang={lang} currency={currency} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.customers}</h2><CustomersView rawData={data} t={t} lang={lang} isPdfMode={true} currency={currency} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.strat.mainTitle}</h2><AnalysisView t={t} lang={lang} currency={currency} /></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
