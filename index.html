<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas 2024 - 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Pinned Versions for Stability) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types (Required dependency for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts (Pinned Version) -->
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        /* PDF Generation Classes */
        .pdf-mode {
            width: 1200px !important;
            min-height: 100vh !important;
            overflow: visible !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9999 !important;
            background: #f8fafc !important;
            padding: 40px !important;
        }
        
        .pdf-mode .grid { display: grid !important; }
        .hide-on-pdf { display: none !important; }
        .page-break { page-break-before: always; margin-top: 40px; border-top: 2px dashed #cbd5e1; padding-top: 40px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LineChart, Line, BarChart, Bar, AreaChart, Area, XAxis, YAxis, 
            CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, ComposedChart 
        } = window.Recharts || {};

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            es: {
                title: "Ventas 2024 - 2025",
                subtitle: "Análisis de venta y márgenes 2024 - 2025",
                footer: "SSC GOURMET DISTRIBUTION",
                sourceInfo: "Información combinada de Odoo y Apsheet",
                tabs: {
                    dashboard: "Dashboard General",
                    growth: "Crecimiento General",
                    margin: "Margen & Rentabilidad",
                    customers: "Análisis por Cliente"
                },
                tabDescriptions: {
                    dashboard: "Vista general de KPIs principales y rendimiento mensual",
                    growth: "Comparativa de crecimiento en ventas y volumen 2024 vs 2025",
                    margin: "Análisis de rentabilidad, evolución de costos y márgenes",
                    customers: "Detalle de facturación y beneficio por cliente y sucursal"
                },
                kpis: {
                    totalRevenue: "Facturación Total",
                    totalKg: "KG Totales Entregados",
                    avgMargin: "Margen Promedio por KG",
                    totalProfit: "Beneficio Total",
                    growthRevenue: "Crecimiento Facturación",
                    growthVol: "Crecimiento Volumen (KG)",
                    marginPct: "% de Margen Global",
                    marginGap: "Diferencia vs 2024",
                    profitability: "Rentabilidad"
                },
                charts: {
                    monthlyRevenue: "Facturación Mensual Comparativa",
                    topClients: "Top 5 Clientes",
                    topRecipes: "Top 5 Recetas (Volumen KG)",
                    monthlyComp: "Comparativa Mensual",
                    quarterly: "Crecimiento Trimestral",
                    volEvolution: "Evolución Volumen (KG)",
                    recipeDist: "Distribución por Receta",
                    priceVsCost: "Evolución Precio vs Costo (Promedios Ponderados)",
                    profitComp: "Composición Beneficio vs Costo",
                    recipeProfit: "Rentabilidad por Receta"
                },
                table: {
                    client: "Razón Social",
                    sale: "Venta",
                    growth: "Crecimiento",
                    q: "Trimestre",
                    change: "Cambio",
                    concept: "Concepto",
                    price: "Precio Prom/KG",
                    cost: "Costo Prom/KG",
                    margin: "Margen/KG",
                    marginPct: "% Margen",
                    recipe: "Receta",
                    profit: "Beneficio Total",
                    branch: "Sucursal",
                    avgVol: "Vol. Prom (Kg/Ticket)",
                    totalVol: "Vol. Total (Kg)",
                    opportunity: "Oportunidad",
                    marginAbs: "Margen $",
                    contribution: "Aportación",
                    others: "Otros (Vol < 20kg)"
                },
                obs: {
                    general: "Observaciones Generales",
                    growth: "Análisis de Crecimiento",
                    margin: "Análisis de Rentabilidad",
                    customers: "Insights de Clientes"
                },
                common: {
                    downloadPdf: "Descargar Vista Actual",
                    downloadFull: "Descargar Informe Completo",
                    loading: "Cargando datos...",
                    error: "Error cargando datos",
                    year: "Año",
                    price: "Precio",
                    cost: "Costo",
                    margin: "Margen",
                    profit: "Beneficio",
                    vs: "vs",
                    generating: "Generando PDF...",
                    allMonths: "Todos los Meses",
                    groupBy: "Agrupar por",
                    fiscalId: "Razón Social",
                    location: "Sucursal",
                    period: "Periodo"
                }
            },
            fr: {
                title: "Ventes 2024 - 2025",
                subtitle: "Analyse des ventes et des marges 2024 - 2025",
                footer: "SSC GOURMET DISTRIBUTION",
                sourceInfo: "Informations combinées d'Odoo et Apsheet",
                tabs: {
                    dashboard: "Tableau de Bord",
                    growth: "Croissance Générale",
                    margin: "Marge & Rentabilité",
                    customers: "Analyse Client"
                },
                tabDescriptions: {
                    dashboard: "Vue d'ensemble des principaux indicateurs et performances mensuelles",
                    growth: "Comparaison de la croissance des ventes et du volume 2024 vs 2025",
                    margin: "Analyse de la rentabilité, évolution des coûts et des marges",
                    customers: "Détail du chiffre d'affaires et bénéfice par client et succursale"
                },
                kpis: {
                    totalRevenue: "Chiffre d'Affaires Total",
                    totalKg: "KG Totaux Livrés",
                    avgMargin: "Marge Moyenne par KG",
                    totalProfit: "Bénéfice Total",
                    growthRevenue: "Croissance CA",
                    growthVol: "Croissance Volume (KG)",
                    marginPct: "% Marge Globale",
                    marginGap: "Écart vs 2024",
                    profitability: "Rentabilité"
                },
                charts: {
                    monthlyRevenue: "Revenus Mensuels Comparatifs",
                    topClients: "Top 5 Clients",
                    topRecipes: "Top 5 Recettes (Volume KG)",
                    monthlyComp: "Comparaison Mensuelle",
                    quarterly: "Croissance Trimestrielle",
                    volEvolution: "Évolution du Volume (KG)",
                    recipeDist: "Répartition par Recette",
                    priceVsCost: "Évolution Prix vs Coût (Moyennes Pondérées)",
                    profitComp: "Composition Bénéfice vs Coût",
                    recipeProfit: "Rentabilité par Recette"
                },
                table: {
                    client: "Raison Sociale",
                    sale: "Vente",
                    growth: "Croissance",
                    q: "Trimestre",
                    change: "Chang.",
                    concept: "Concept",
                    price: "Prix Moy/KG",
                    cost: "Coût Moy/KG",
                    margin: "Marge/KG",
                    marginPct: "% Marge",
                    recipe: "Recette",
                    profit: "Bénéfice Total",
                    branch: "Succursale",
                    avgVol: "Vol. Moy (Kg/Ticket)",
                    totalVol: "Vol. Total (Kg)",
                    opportunity: "Opportunité",
                    marginAbs: "Marge $",
                    contribution: "Contribution",
                    others: "Autres (Vol < 20kg)"
                },
                obs: {
                    general: "Observations Générales",
                    growth: "Analyse de la Croissance",
                    margin: "Analyse de Rentabilité",
                    customers: "Aperçu Client"
                },
                common: {
                    downloadPdf: "Télécharger la Vue Actuelle",
                    downloadFull: "Télécharger le Rapport Complet",
                    loading: "Chargement des données...",
                    error: "Erreur de chargement",
                    year: "Année",
                    price: "Prix",
                    cost: "Coût",
                    margin: "Marge",
                    profit: "Bénéfice",
                    vs: "vs",
                    generating: "Génération du PDF...",
                    allMonths: "Tous les mois",
                    groupBy: "Grouper par",
                    fiscalId: "Raison Sociale",
                    location: "Succursale",
                    period: "Période"
                }
            },
            en: {
                title: "Sales 2024 - 2025",
                subtitle: "Sales and margin analysis 2024 - 2025",
                footer: "SSC GOURMET DISTRIBUTION",
                sourceInfo: "Combined info from Odoo and Appsheet",
                tabs: {
                    dashboard: "General Dashboard",
                    growth: "General Growth",
                    margin: "Margin & Profitability",
                    customers: "Customer Analysis"
                },
                tabDescriptions: {
                    dashboard: "Overview of main KPIs and monthly performance",
                    growth: "Sales and volume growth comparison 2024 vs 2025",
                    margin: "Profitability analysis, cost evolution, and margins",
                    customers: "Revenue and profit detail by client and branch"
                },
                kpis: {
                    totalRevenue: "Total Revenue",
                    totalKg: "Total KG Delivered",
                    avgMargin: "Avg Margin per KG",
                    totalProfit: "Total Profit",
                    growthRevenue: "Revenue Growth",
                    growthVol: "Volume Growth (KG)",
                    marginPct: "Global Margin %",
                    marginGap: "Diff vs 2024",
                    profitability: "Profitability"
                },
                charts: {
                    monthlyRevenue: "Comparative Monthly Revenue",
                    topClients: "Top 5 Clients",
                    topRecipes: "Top 5 Recipes (Volume KG)",
                    monthlyComp: "Comparative Monthly",
                    quarterly: "Quarterly Growth",
                    volEvolution: "Volume Evolution (KG)",
                    recipeDist: "Distribution by Recipe",
                    priceVsCost: "Price vs Cost Evolution (Weighted Avg)",
                    profitComp: "Profit vs Cost Composition",
                    recipeProfit: "Profitability by Recipe"
                },
                table: {
                    client: "Client Name",
                    sale: "Sales",
                    growth: "Growth",
                    q: "Quarter",
                    change: "Change",
                    concept: "Concept",
                    price: "Avg Price/KG",
                    cost: "Avg Cost/KG",
                    margin: "Margin/KG",
                    marginPct: "% Margin",
                    recipe: "Recipe",
                    profit: "Total Profit",
                    branch: "Branch",
                    avgVol: "Avg Vol (Kg/Ticket)",
                    totalVol: "Total Vol (Kg)",
                    opportunity: "Opportunity",
                    marginAbs: "Margin $",
                    contribution: "Contribution",
                    others: "Others (Vol < 20kg)"
                },
                obs: {
                    general: "General Observations",
                    growth: "Growth Analysis",
                    margin: "Profitability Analysis",
                    customers: "Customer Insights"
                },
                common: {
                    downloadPdf: "Download Current View",
                    downloadFull: "Download Full Report",
                    loading: "Loading data...",
                    error: "Error loading data",
                    year: "Year",
                    price: "Price",
                    cost: "Cost",
                    margin: "Margin",
                    profit: "Profit",
                    vs: "vs",
                    generating: "Generating PDF...",
                    allMonths: "All Months",
                    groupBy: "Group by",
                    fiscalId: "Legal Name",
                    location: "Branch",
                    period: "Period"
                }
            }
        };

        // --- ICONS ---
        const Icon = ({ name, className }) => {
            const icons = {
                dollar: <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
                scale: <g><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" strokeLinejoin="round"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></g>,
                trendingUp: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
                chart: <g><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></g>,
                pie: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                fileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></g>,
                dashboard: <g><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></g>,
                loader: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                globe: <g><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></g>,
                users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                filter: <g><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></g>,
                alert: <g><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></g>,
                clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
                calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                chevronDown: <polyline points="6 9 12 15 18 9"/>,
                chevronUp: <polyline points="18 15 12 9 6 15"/>,
                list: <g><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || icons.dollar}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwGH9wsueZV2np8T7JA8xqBpEVN1Y1qIF-4WtOpPjlV3-07x3F8bdUIawWwxpVcX7Wx/exec";
        const COLORS = {
            year2024: "#4169E1", year2024Light: "#93c5fd",
            year2025: "#9333EA", year2025Light: "#d8b4fe",
            positive: "#10b981", negative: "#ef4444", grid: "#e2e8f0"
        };
        const MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        // --- UTILS ---
        const formatCurrency = (val, lang = 'es') => {
            let locale = 'es-MX';
            if (lang === 'fr') locale = 'fr-FR';
            if (lang === 'en') locale = 'en-US';
            return new Intl.NumberFormat(locale, { style: 'currency', currency: 'MXN' }).format(val);
        };
        const formatNumber = (val, lang = 'es') => {
            let locale = 'es-MX';
            if (lang === 'fr') locale = 'fr-FR';
            if (lang === 'en') locale = 'en-US';
            return new Intl.NumberFormat(locale, { maximumFractionDigits: 2 }).format(val);
        };
        const parseDate = (dateStr) => {
            if (!dateStr) return new Date();
            let s = String(dateStr); if (s.includes('T')) s = s.split('T')[0];
            const parts = s.split('-');
            if (parts.length === 3) return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            return new Date(dateStr);
        };

        // --- COMPONENTS ---
        const LanguageSelector = ({ lang, setLang, isMobile = false }) => {
            const languages = [
                { code: 'es', label: 'ES' },
                { code: 'fr', label: 'FR' },
                { code: 'en', label: 'EN' }
            ];

            return (
                <div className={`flex ${isMobile ? 'gap-1' : 'gap-2'} bg-slate-800 p-1 rounded-lg justify-center w-full md:w-auto`}>
                    {languages.map((l) => (
                        <button
                            key={l.code}
                            onClick={() => setLang(l.code)}
                            className={`
                                px-2 py-1 rounded transition-all text-xs font-bold flex items-center gap-1 flex-1 justify-center
                                ${lang === l.code 
                                    ? 'bg-blue-600 text-white shadow' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-700'}
                            `}
                        >
                            <span>{l.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [processedData, setProcessedData] = useState(null);
            const [lang, setLang] = useState('es');
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const contentRef = useRef(null);
            const fullReportRef = useRef(null);

            useEffect(() => {
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('fr')) setLang('fr'); 
                else if (browserLang.startsWith('en')) setLang('en');
                else setLang('es');
            }, []);

            const t = TRANSLATIONS[lang];

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(API_URL, { redirect: "follow" });
                        if (!response.ok) throw new Error("Network response was not ok");
                        const jsonData = await response.json();
                        
                        let finalData = Array.isArray(jsonData) ? jsonData : jsonData.data || jsonData.items || [];
                        const normalizedData = finalData.map(item => {
                            const newItem = {};
                            Object.keys(item).forEach(key => newItem[key.toLowerCase().trim().replace(/\s+/g, '_')] = item[key]);
                            return newItem;
                        });
                        setData(normalizedData);
                        processAllData(normalizedData);
                        setLoading(false);

                    } catch (err) {
                        console.error("Fetch Error:", err);
                        setError("Error de conexión. Por favor verifica que el App Script esté desplegado como 'Aplicación web' y accesible para 'Cualquier usuario' (Anyone).");
                        setLoading(false);
                    }
                };
                
                fetchData();
            }, [lang]); 

            const processAllData = (rawData) => {
                // Same processing logic as before
                const monthlyData = Array(12).fill(0).map((_, i) => ({
                    name: MONTHS[i], monthIndex: i,
                    sales2024: 0, sales2025: 0, kg2024: 0, kg2025: 0,
                    cost2024: 0, cost2025: 0, profit2024: 0, profit2025: 0
                }));
                const clients = {}; const recipes = {};
                let totals = { sales2024: 0, sales2025: 0, kg2024: 0, kg2025: 0, profit2024: 0, profit2025: 0 };

                rawData.forEach(item => {
                    const date = parseDate(item.invoice_date);
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const parseNum = (val) => {
                        if (typeof val === 'number') return val; if (!val) return 0;
                        const cleanStr = String(val).replace(/[$,]/g, ''); return isNaN(parseFloat(cleanStr)) ? 0 : parseFloat(cleanStr);
                    };
                    const sale = parseNum(item.item_sale);
                    const kg = parseNum(item.item_coffee_weight_sum);
                    const totalCost = parseNum(item.coffee_total_cost);
                    const profit = sale - totalCost;
                    const clientId = item.client_fiscal_id || "Desconocido";
                    const recipeId = item.item_recipe || "Generico";

                    if (!clients[clientId]) clients[clientId] = { name: clientId, sales2024: 0, sales2025: 0 };
                    if (!recipes[recipeId]) recipes[recipeId] = { name: recipeId, kg2024: 0, kg2025: 0, profit2025: 0, sales2025: 0 };

                    if (year === 2024) {
                        monthlyData[month].sales2024 += sale; monthlyData[month].kg2024 += kg;
                        monthlyData[month].cost2024 += totalCost; monthlyData[month].profit2024 += profit;
                        totals.sales2024 += sale; totals.kg2024 += kg; totals.profit2024 += profit;
                        clients[clientId].sales2024 += sale; recipes[recipeId].kg2024 += kg;
                    } else if (year === 2025) {
                        monthlyData[month].sales2025 += sale; monthlyData[month].kg2025 += kg;
                        monthlyData[month].cost2025 += totalCost; monthlyData[month].profit2025 += profit;
                        totals.sales2025 += sale; totals.kg2025 += kg; totals.profit2025 += profit;
                        clients[clientId].sales2025 += sale; recipes[recipeId].kg2025 += kg;
                        recipes[recipeId].profit2025 += profit; recipes[recipeId].sales2025 += sale;
                    }
                });

                monthlyData.forEach(m => {
                    m.avgPrice2024 = m.kg2024 > 0 ? m.sales2024 / m.kg2024 : 0;
                    m.avgCost2024 = m.kg2024 > 0 ? m.cost2024 / m.kg2024 : 0;
                    m.avgPrice2025 = m.kg2025 > 0 ? m.sales2025 / m.kg2025 : 0;
                    m.avgCost2025 = m.kg2025 > 0 ? m.cost2025 / m.kg2025 : 0;
                });

                totals.avgMarginPerKg2024 = totals.kg2024 > 0 ? totals.profit2024 / totals.kg2024 : 0;
                totals.avgMarginPerKg2025 = totals.kg2025 > 0 ? totals.profit2025 / totals.kg2025 : 0;
                totals.marginPct2024 = totals.sales2024 > 0 ? (totals.profit2024 / totals.sales2024) * 100 : 0;
                totals.marginPct2025 = totals.sales2025 > 0 ? (totals.profit2025 / totals.sales2025) * 100 : 0;

                setProcessedData({
                    monthly: monthlyData,
                    clients: Object.values(clients).sort((a,b) => b.sales2025 - a.sales2025),
                    recipes: Object.values(recipes).sort((a,b) => b.kg2025 - a.kg2025),
                    totals: totals
                });
            };

            const generatePdfFromElement = async (element, filename) => {
                const originalWidth = element.style.width;
                element.style.width = '1200px'; 
                try {
                    const canvas = await html2canvas(element, { scale: 1.5, useCORS: true, logging: false, windowWidth: 1200, backgroundColor: '#f8fafc' });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    let heightLeft = pdfHeight, position = 0;
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft >= 0) {
                        position = heightLeft - pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(filename);
                } catch (e) { console.error("PDF Error", e); } 
                finally { element.style.width = originalWidth; }
            };

            const handleDownloadCurrentView = async () => {
                if (!contentRef.current) return;
                const element = contentRef.current;
                element.classList.add('pdf-mode');
                await new Promise(r => setTimeout(r, 500)); 
                await generatePdfFromElement(element, `Report_${activeTab}.pdf`);
                element.classList.remove('pdf-mode');
            };

            const handleDownloadFullReport = async () => {
                setIsGeneratingPdf(true);
                await new Promise(r => setTimeout(r, 2500)); 
                if (fullReportRef.current) await generatePdfFromElement(fullReportRef.current, `Informe_Completo_Ventas.pdf`);
                setIsGeneratingPdf(false);
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-gray-50"><div className="text-center"><Icon name="loader" className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-4" /><h2 className="text-xl font-semibold text-gray-700">{t.common.loading}</h2></div></div>;
            if (error || !processedData) return <div className="p-10 text-red-600 text-center">{error}</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20 hidden md:flex">
                        <div className="p-6 border-b border-slate-800 flex flex-col items-center text-center">
                            <img src="assets/whitelabel.png" alt="Logo" className="w-full max-w-[180px] h-auto mb-4 object-contain" />
                            <p className="text-xs text-slate-400 font-medium">{t.subtitle}</p>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <NavButton id="dashboard" label={t.tabs.dashboard} icon="dashboard" active={activeTab} set={setActiveTab} />
                            <NavButton id="growth" label={t.tabs.growth} icon="trendingUp" active={activeTab} set={setActiveTab} />
                            <NavButton id="margin" label={t.tabs.margin} icon="dollar" active={activeTab} set={setActiveTab} />
                            <NavButton id="customers" label={t.tabs.customers} icon="users" active={activeTab} set={setActiveTab} />
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <LanguageSelector lang={lang} setLang={setLang} />
                        </div>
                        <div className="p-4 border-t border-slate-800 text-[10px] text-slate-500 text-center font-bold tracking-wider">{t.footer}</div>
                    </aside>

                    <div className="md:hidden fixed top-0 w-full bg-slate-900 text-white z-30 p-4 flex justify-between items-center shadow-md">
                        <span className="font-bold">{t.title}</span>
                        <div className="flex gap-2">
                            <LanguageSelector lang={lang} setLang={setLang} isMobile={true} />
                        </div>
                    </div>
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 z-30 flex justify-around p-2">
                         {['dashboard','growth','margin','customers'].map(tab => (
                             <button key={tab} onClick={() => setActiveTab(tab)} className={`p-2 rounded-full ${activeTab === tab ? 'bg-blue-100 text-blue-600' : 'text-gray-500'}`}><Icon name={tab === 'customers' ? 'users' : (tab === 'margin' ? 'dollar' : (tab === 'growth' ? 'trendingUp' : 'dashboard'))} className="w-6 h-6"/></button>
                         ))}
                    </div>

                    <main className="flex-1 overflow-y-auto bg-gray-50 relative pt-16 md:pt-0 pb-16 md:pb-0" ref={contentRef}>
                        <div className="max-w-7xl mx-auto p-4 md:p-8">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                <div><h2 className="text-2xl md:text-3xl font-bold text-slate-800">{t.tabs[activeTab]}</h2><p className="text-slate-500 mt-1 text-sm">{t.tabDescriptions[activeTab]}</p></div>
                                <div className="flex gap-2"><button onClick={handleDownloadFullReport} disabled={isGeneratingPdf} className="hide-on-pdf flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition-all text-sm font-medium disabled:opacity-50">{isGeneratingPdf ? <Icon name="loader" className="w-4 h-4 animate-spin"/> : <Icon name="fileText" className="w-4 h-4" />}{isGeneratingPdf ? t.common.generating : t.common.downloadFull}</button></div>
                            </div>
                            {activeTab === 'dashboard' && <DashboardView data={processedData} t={t} lang={lang} />}
                            {activeTab === 'growth' && <GrowthView data={processedData} t={t} lang={lang} />}
                            {activeTab === 'margin' && <MarginView data={processedData} t={t} lang={lang} />}
                            {activeTab === 'customers' && <CustomersView rawData={data} t={t} lang={lang} />}
                        </div>
                    </main>

                    {isGeneratingPdf && (
                        <div ref={fullReportRef} className="pdf-mode">
                            <div className="mb-8 border-b pb-4"><h1 className="text-3xl font-bold text-slate-900">{t.title}</h1><p className="text-slate-500">{t.subtitle} - {t.footer}</p><p className="text-sm text-slate-400 mt-1">{new Date().toLocaleDateString()}</p></div>
                            <div className="mb-8"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.dashboard}</h2><DashboardView data={processedData} t={t} lang={lang} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.growth}</h2><GrowthView data={processedData} t={t} lang={lang} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.margin}</h2><MarginView data={processedData} t={t} lang={lang} /></div>
                            <div className="page-break"><h2 className="text-2xl font-bold text-blue-600 mb-4">{t.tabs.customers}</h2><CustomersView rawData={data} t={t} lang={lang} isPdfMode={true} /></div>
                        </div>
                    )}
                </div>
            );
        };

        const NavButton = ({ id, label, icon, active, set }) => (
            <button onClick={() => set(id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-left ${active === id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                <Icon name={icon} className="w-5 h-5 flex-shrink-0" /><span className="font-medium text-sm">{label}</span>
            </button>
        );

        const KPICard = ({ title, value, subValue, icon, isPositive }) => (
            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-start justify-between relative overflow-hidden">
                <div className="z-10 relative overflow-hidden w-full mr-2">
                    <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{title}</p>
                    <h3 className="text-xl md:text-2xl font-bold text-gray-800 truncate" title={value}>{value}</h3>
                    {subValue && <div className={`flex items-center gap-1 mt-2 text-xs font-bold ${isPositive ? 'text-green-600' : 'text-red-500'}`}><span>{isPositive ? '↑' : '↓'}</span><span>{subValue}</span></div>}
                </div>
                <div className={`p-3 rounded-lg flex-shrink-0 ${isPositive === false ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-600'}`}><Icon name={icon} className="w-6 h-6" /></div>
            </div>
        );

        const InsightBox = ({ title, insights }) => (
            <div className="bg-white border-l-4 border-blue-500 shadow-sm rounded-r-xl p-6 mt-8">
                <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="dashboard" className="w-5 h-5 text-blue-500" />{title}</h4>
                <ul className="space-y-3">{insights.map((insight, idx) => <li key={idx} className="flex items-start gap-3 text-sm text-slate-600"><span className="w-1.5 h-1.5 rounded-full bg-slate-300 mt-2 flex-shrink-0"></span>{insight}</li>)}</ul>
            </div>
        );

        // --- DASHBOARD VIEW ---
        const DashboardView = ({ data, t, lang }) => {
            const { totals, monthly, clients } = data;
            const salesGrowthPct = totals.sales2024 > 0 ? ((totals.sales2025 - totals.sales2024) / totals.sales2024) * 100 : 0;
            const kgGrowthPct = totals.kg2024 > 0 ? ((totals.kg2025 - totals.kg2024) / totals.kg2024) * 100 : 0;
            const marginDiff = totals.avgMarginPerKg2025 - totals.avgMarginPerKg2024;
            const profitGrowthPct = totals.profit2024 > 0 ? ((totals.profit2025 - totals.profit2024) / totals.profit2024) * 100 : 0;
            const insights = [`${t.kpis.growthRevenue}: ${salesGrowthPct.toFixed(1)}% ${t.common.vs} 2024.`, `${t.kpis.totalKg}: ${formatNumber(totals.kg2025 - totals.kg2024, lang)} kg (${kgGrowthPct > 0 ? '+' : ''}${kgGrowthPct.toFixed(1)}%).`, `${t.kpis.avgMargin}: ${marginDiff >= 0 ? '+' : ''}${formatCurrency(marginDiff, lang)} ${t.common.vs} 2024.`];

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KPICard title={`${t.kpis.totalRevenue} 2025`} value={formatCurrency(totals.sales2025, lang)} subValue={`${salesGrowthPct.toFixed(1)}%`} isPositive={salesGrowthPct > 0} icon="dollar" />
                        <KPICard title={`${t.kpis.totalKg} 2025`} value={`${formatNumber(totals.kg2025, lang)} kg`} subValue={`${kgGrowthPct.toFixed(1)}%`} isPositive={kgGrowthPct > 0} icon="scale" />
                        <KPICard title={t.kpis.avgMargin} value={formatCurrency(totals.avgMarginPerKg2025, lang)} subValue={`${formatCurrency(marginDiff, lang)}`} isPositive={marginDiff >= 0} icon="chart" />
                        <KPICard title={t.kpis.totalProfit} value={formatCurrency(totals.profit2025, lang)} subValue={`${profitGrowthPct.toFixed(1)}%`} isPositive={profitGrowthPct > 0} icon="trendingUp" />
                    </div>
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-6">{t.charts.monthlyRevenue}</h3>
                            <div className="h-72"><ResponsiveContainer><LineChart data={monthly}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip formatter={(v)=>formatCurrency(v,lang)}/><Legend/><Line type="monotone" dataKey="sales2024" stroke={COLORS.year2024}/><Line type="monotone" dataKey="sales2025" stroke={COLORS.year2025}/></LineChart></ResponsiveContainer></div>
                        </div>
                        <div className="w-full lg:w-2/5 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-6">{t.charts.topClients}</h3>
                            <div className="overflow-x-auto"><table className="w-full text-xs md:text-sm text-left text-gray-500"><thead className="text-xs text-gray-700 uppercase bg-gray-50"><tr><th className="px-3 py-2 rounded-l-lg">{t.table.client}</th><th className="px-3 py-2 text-right">{t.table.sale}</th><th className="px-3 py-2 text-right rounded-r-lg">{t.table.growth}</th></tr></thead><tbody>{clients.slice(0, 5).map((client, idx) => { const growth = client.sales2024 > 0 ? ((client.sales2025 - client.sales2024) / client.sales2024) * 100 : 100; return (<tr key={idx} className="border-b hover:bg-gray-50"><td className="px-3 py-2 font-medium text-gray-900 text-xs md:text-sm whitespace-normal break-words" title={client.name}>{client.name}</td><td className="px-3 py-2 text-right">{formatCurrency(client.sales2025, lang)}</td><td className={`px-3 py-2 text-right font-bold ${growth >= 0 ? 'text-green-600' : 'text-red-500'}`}>{growth >= 0 ? '↑' : '↓'} {Math.abs(growth).toFixed(0)}%</td></tr>); })}</tbody></table></div>
                        </div>
                    </div>
                    <InsightBox title={t.obs.general} insights={insights} />
                </div>
            );
        };

        const GrowthView = ({ data, t, lang }) => {
            const { monthly, totals } = data;
            const quarters = [{name:'Q1',months:[0,1,2]},{name:'Q2',months:[3,4,5]},{name:'Q3',months:[6,7,8]},{name:'Q4',months:[9,10,11]}].map(q => { const s24=q.months.reduce((a,m)=>a+monthly[m].sales2024,0); const s25=q.months.reduce((a,m)=>a+monthly[m].sales2025,0); return {name:q.name,sales2024:s24,sales2025:s25,pct:s24>0?((s25-s24)/s24)*100:0}; });
            const insights = [`${t.kpis.growthRevenue}: +${formatCurrency(totals.sales2025 - totals.sales2024, lang)}.`];
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><KPICard title={t.kpis.growthRevenue} value={formatCurrency(totals.sales2025 - totals.sales2024, lang)} isPositive={true} icon="dollar" /><KPICard title={t.kpis.growthVol} value={`${formatNumber(totals.kg2025 - totals.kg2024, lang)} kg`} isPositive={true} icon="scale" /></div>
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-4">{t.charts.monthlyComp}</h3><div className="h-64"><ResponsiveContainer><BarChart data={monthly}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name"/><YAxis/><Tooltip formatter={(v)=>formatCurrency(v,lang)}/><Bar dataKey="sales2024" fill={COLORS.year2024}/><Bar dataKey="sales2025" fill={COLORS.year2025}/></BarChart></ResponsiveContainer></div></div>
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-4">{t.charts.quarterly}</h3><table className="w-full text-xs md:text-sm"><thead className="bg-gray-50 text-gray-600"><tr><th className="px-3 py-2 text-left">{t.table.q}</th><th className="px-3 py-2 text-right">2024</th><th className="px-3 py-2 text-right">2025</th><th className="px-3 py-2 text-right">{t.table.change}</th></tr></thead><tbody>{quarters.map((q,i)=>(<tr key={i} className="border-b"><td className="px-3 py-2 font-medium">{q.name}</td><td className="px-3 py-2 text-right">{formatCurrency(q.sales2024,lang)}</td><td className="px-3 py-2 text-right">{formatCurrency(q.sales2025,lang)}</td><td className={`px-3 py-2 text-right font-bold ${q.pct>=0?'text-green-600':'text-red-500'}`}>{q.pct.toFixed(1)}%</td></tr>))}</tbody></table></div>
                    </div>
                    <InsightBox title={t.obs.growth} insights={insights} />
                </div>
            );
        };

        const MarginView = ({ data, t, lang }) => {
            const { monthly, totals } = data;
            const [selectedYear, setSelectedYear] = useState('2025');
            const marginChange = totals.avgMarginPerKg2025 - totals.avgMarginPerKg2024;
            const marginPctChange = totals.marginPct2025 - totals.marginPct2024;
            const insights = [`${t.kpis.avgMargin}: ${formatCurrency(totals.avgMarginPerKg2025, lang)}.`];
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <KPICard title={t.kpis.avgMargin} value={formatCurrency(totals.avgMarginPerKg2025, lang)} subValue={formatCurrency(marginChange, lang)} isPositive={marginChange >= 0} icon="dollar" />
                        <KPICard title={t.kpis.marginPct} value={`${totals.marginPct2025.toFixed(1)}%`} subValue={`${marginPctChange.toFixed(1)}%`} isPositive={marginPctChange >= 0} icon="chart" />
                        <KPICard title={t.kpis.totalProfit} value={formatCurrency(totals.profit2025, lang)} isPositive={true} icon="trendingUp" />
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-gray-700">{t.charts.priceVsCost}</h3><div className="flex bg-gray-100 rounded-lg p-1"><button onClick={()=>setSelectedYear('2024')} className={`px-3 py-1 text-xs font-bold rounded-md ${selectedYear==='2024'?'bg-white shadow text-blue-600':''}`}>2024</button><button onClick={()=>setSelectedYear('2025')} className={`px-3 py-1 text-xs font-bold rounded-md ${selectedYear==='2025'?'bg-white shadow text-purple-600':''}`}>2025</button></div></div><div className="h-80"><ResponsiveContainer><AreaChart data={monthly}><defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={selectedYear==='2025'?COLORS.year2025:COLORS.year2024} stopOpacity={0.2}/><stop offset="95%" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name"/><YAxis/><Tooltip formatter={(v)=>formatCurrency(v,lang)}/><Area type="monotone" dataKey={`avgCost${selectedYear}`} stroke="#ef4444" fill="transparent" strokeDasharray="5 5"/><Area type="monotone" dataKey={`avgPrice${selectedYear}`} stroke={selectedYear==='2025'?COLORS.year2025:COLORS.year2024} fill="url(#g)"/></AreaChart></ResponsiveContainer></div></div>
                    <InsightBox title={t.obs.margin} insights={insights} />
                </div>
            );
        };

        const CustomersView = ({ rawData, t, lang, isPdfMode }) => {
            const [selectedYears, setSelectedYears] = useState(['2024']);
            const [startMonth, setStartMonth] = useState(0);
            const [endMonth, setEndMonth] = useState(11);
            const [groupBy, setGroupBy] = useState('fiscal_id');
            const [sortConfig, setSortConfig] = useState({ key: 'profit', direction: 'desc' });
            const [othersExpanded, setOthersExpanded] = useState(false);
            
            const handleSort = (key) => setSortConfig({ key, direction: sortConfig.key === key && sortConfig.direction === 'desc' ? 'asc' : 'desc' });
            const getSortIcon = (key) => sortConfig.key !== key ? <span className="ml-1 text-gray-300">↕</span> : (sortConfig.direction === 'asc' ? <span className="ml-1 text-blue-600">↑</span> : <span className="ml-1 text-blue-600">↓</span>);
            
            const toggleYear = (year) => {
                if (selectedYears.includes(year)) {
                    if (selectedYears.length > 1) setSelectedYears(selectedYears.filter(y => y !== year));
                } else {
                    setSelectedYears([...selectedYears, year]);
                }
            };

            const { customerData, summary, othersData } = useMemo(() => {
                const grouped = {};
                let totalFilteredProfit = 0;

                rawData.forEach(item => {
                    const date = parseDate(item.invoice_date);
                    const year = String(date.getFullYear());
                    const month = date.getMonth();

                    if (!selectedYears.includes(year)) return;
                    if (month < startMonth || month > endMonth) return;

                    let key = groupBy === 'fiscal_id' ? (item.client_fiscal_id || "N/A") : (item.client_location || "N/A");
                    if (!grouped[key]) grouped[key] = { name: key, totalRevenue: 0, totalCost: 0, totalKg: 0, invoiceCount: new Set() };
                    const sale = parseFloat(String(item.item_sale).replace(/[$,]/g, '')) || 0;
                    const cost = parseFloat(String(item.coffee_total_cost).replace(/[$,]/g, '')) || 0;
                    const kg = parseFloat(String(item.item_coffee_weight_sum).replace(/[$,]/g, '')) || 0;
                    grouped[key].totalRevenue += sale; grouped[key].totalCost += cost; grouped[key].totalKg += kg;
                    if(item.invoice_number) grouped[key].invoiceCount.add(item.invoice_number);
                });

                const allCustomers = Object.values(grouped).map(g => {
                    const profit = g.totalRevenue - g.totalCost;
                    return { ...g, profit };
                });

                totalFilteredProfit = allCustomers.reduce((acc, c) => acc + c.profit, 0);

                const main = [];
                const others = [];
                let othersAgg = { name: t.table.others, totalRevenue: 0, totalCost: 0, totalKg: 0, profit: 0, invoiceCount: 0, isOthers: true };

                allCustomers.forEach(c => {
                    const avgPricePerKg = c.totalKg > 0 ? c.totalRevenue / c.totalKg : 0;
                    const marginPct = c.totalRevenue > 0 ? (c.profit / c.totalRevenue) * 100 : 0;
                    const uniqueInvoices = c.invoiceCount.size || 1;
                    const avgVolPerInvoice = c.totalKg / uniqueInvoices;
                    const contribPct = totalFilteredProfit !== 0 ? (c.profit / totalFilteredProfit) * 100 : 0;

                    const enriched = { ...c, avgPricePerKg, marginPct, avgVolPerInvoice, contribPct };

                    if (c.totalKg < 20) {
                        others.push(enriched);
                        othersAgg.totalRevenue += c.totalRevenue;
                        othersAgg.totalCost += c.totalCost;
                        othersAgg.totalKg += c.totalKg;
                        othersAgg.profit += c.profit;
                        othersAgg.invoiceCount += uniqueInvoices;
                    } else {
                        main.push(enriched);
                    }
                });

                if (others.length > 0) {
                    othersAgg.avgPricePerKg = othersAgg.totalKg > 0 ? othersAgg.totalRevenue / othersAgg.totalKg : 0;
                    othersAgg.marginPct = othersAgg.totalRevenue > 0 ? (othersAgg.profit / othersAgg.totalRevenue) * 100 : 0;
                    othersAgg.avgVolPerInvoice = othersAgg.totalKg / (othersAgg.invoiceCount || 1); // Approximation for others
                    othersAgg.contribPct = totalFilteredProfit !== 0 ? (othersAgg.profit / totalFilteredProfit) * 100 : 0;
                    main.push(othersAgg);
                }

                // Sort main
                main.sort((a,b) => {
                    if (a.isOthers) return 1; // Always last
                    if (b.isOthers) return -1;
                    const valA = a[sortConfig.key], valB = b[sortConfig.key];
                    if (sortConfig.key === 'name') return sortConfig.direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
                    return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
                });

                return { 
                    customerData: main, 
                    othersData: others.sort((a,b) => b.profit - a.profit),
                    summary: {
                        revenue: allCustomers.reduce((acc, c) => acc + c.totalRevenue, 0),
                        profit: totalFilteredProfit,
                        kg: allCustomers.reduce((acc, c) => acc + c.totalKg, 0)
                    }
                };
            }, [rawData, selectedYears, startMonth, endMonth, groupBy, sortConfig, t]);

            const insights = [
                `Top Cliente: ${customerData.length > 0 ? customerData[0].name : 'N/A'} con ${formatCurrency(customerData.length > 0 ? customerData[0].profit : 0, lang)} de beneficio.`,
                `Total procesado en esta vista: ${formatNumber(summary.kg, lang)} kg.`
            ];

            return (
                <div className="space-y-6 animate-fade-in">
                    {!isPdfMode && (
                        <div className="flex flex-wrap gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 items-center justify-between">
                            <div className="flex items-center bg-gray-200 rounded-lg p-1">
                                <button onClick={() => setGroupBy('fiscal_id')} className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${groupBy === 'fiscal_id' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{t.common.fiscalId}</button>
                                <button onClick={() => setGroupBy('location')} className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${groupBy === 'location' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{t.common.location}</button>
                            </div>
                            <div className="flex flex-wrap gap-4 items-center">
                                <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-200"><span className="text-sm text-gray-500 font-medium">{t.common.year}:</span><div className="flex gap-1">{['2024', '2025'].map(year => (<button key={year} onClick={() => toggleYear(year)} className={`px-3 py-1 text-xs font-bold rounded border transition-colors ${selectedYears.includes(year) ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100'}`}>{year}</button>))}</div></div>
                                <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-200"><span className="text-sm text-gray-500 font-medium">Meses:</span><select value={startMonth} onChange={(e) => { const val = parseInt(e.target.value); setStartMonth(val); if (val > endMonth) setEndMonth(val); }} className="bg-gray-50 border border-gray-300 text-gray-700 text-xs rounded focus:ring-blue-500 focus:border-blue-500 p-1.5">{MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select><span className="text-gray-400">-</span><select value={endMonth} onChange={(e) => { const val = parseInt(e.target.value); setEndMonth(val); if (val < startMonth) setStartMonth(val); }} className="bg-gray-50 border border-gray-300 text-gray-700 text-xs rounded focus:ring-blue-500 focus:border-blue-500 p-1.5">{MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select></div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <KPICard title={t.kpis.profitability} value={formatCurrency(summary.profit, lang)} isPositive={true} icon="trendingUp" />
                        <KPICard title={t.kpis.totalRevenue} value={formatCurrency(summary.revenue, lang)} isPositive={true} icon="dollar" />
                        <KPICard title={t.kpis.totalKg} value={`${formatNumber(summary.kg, lang)} kg`} isPositive={true} icon="scale" />
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm overflow-x-auto"><table className="w-full text-xs md:text-sm text-left"><thead className="bg-slate-50 text-slate-700 uppercase"><tr><th onClick={()=>handleSort('name')} className="px-4 py-3 cursor-pointer hover:bg-slate-100">{groupBy==='fiscal_id'?t.table.client:t.table.branch} {getSortIcon('name')}</th><th onClick={()=>handleSort('totalRevenue')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.sale} {getSortIcon('totalRevenue')}</th><th onClick={()=>handleSort('profit')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.profit} {getSortIcon('profit')}</th><th onClick={()=>handleSort('contribPct')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.contribution} {getSortIcon('contribPct')}</th><th onClick={()=>handleSort('marginPct')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.marginPct} {getSortIcon('marginPct')}</th><th onClick={()=>handleSort('totalKg')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.totalVol} {getSortIcon('totalKg')}</th><th onClick={()=>handleSort('avgVolPerInvoice')} className="px-4 py-3 text-right cursor-pointer hover:bg-slate-100">{t.table.avgVol} {getSortIcon('avgVolPerInvoice')}</th></tr></thead><tbody>
                        {customerData.map((row,i) => (
                            <React.Fragment key={i}>
                                <tr className={`border-b hover:bg-gray-50 ${row.isOthers ? 'bg-gray-50 italic cursor-pointer' : ''}`} onClick={row.isOthers ? () => setOthersExpanded(!othersExpanded) : undefined}>
                                    <td className="px-4 py-2 font-medium whitespace-normal break-words min-w-[150px]" title={row.name}>
                                        {row.isOthers && <span className="mr-2">{othersExpanded ? '▼' : '▶'}</span>}
                                        {row.name}
                                    </td>
                                    <td className="px-4 py-2 text-right">{formatCurrency(row.totalRevenue, lang)}</td>
                                    <td className="px-4 py-2 text-right text-green-600 font-bold">{formatCurrency(row.profit, lang)}</td>
                                    <td className="px-4 py-2 text-right">{row.contribPct.toFixed(1)}%</td>
                                    <td className="px-4 py-2 text-right">{row.marginPct.toFixed(1)}%</td>
                                    <td className="px-4 py-2 text-right">{formatNumber(row.totalKg, lang)}</td>
                                    <td className="px-4 py-2 text-right">{formatNumber(row.avgVolPerInvoice, lang)}</td>
                                </tr>
                                {row.isOthers && othersExpanded && othersData.map((sub, j) => (
                                    <tr key={`sub-${j}`} className="border-b bg-gray-50/50 text-gray-500 text-xs">
                                        <td className="px-4 py-1 pl-8 truncate">{sub.name}</td>
                                        <td className="px-4 py-1 text-right">{formatCurrency(sub.totalRevenue, lang)}</td>
                                        <td className="px-4 py-1 text-right">{formatCurrency(sub.profit, lang)}</td>
                                        <td className="px-4 py-1 text-right">{sub.contribPct.toFixed(2)}%</td>
                                        <td className="px-4 py-1 text-right">{sub.marginPct.toFixed(1)}%</td>
                                        <td className="px-4 py-1 text-right">{formatNumber(sub.totalKg, lang)}</td>
                                        <td className="px-4 py-1 text-right">{formatNumber(sub.avgVolPerInvoice, lang)}</td>
                                    </tr>
                                ))}
                            </React.Fragment>
                        ))}
                    </tbody></table></div>
                    <InsightBox title={t.obs.customers} insights={insights} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
